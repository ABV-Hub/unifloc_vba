\section{Расчёт свойств потока}

В отличии от функций расчета PVT (физико-химических свойств флюидов) функции расчета свойства потока учитывают дополнительные параметры потока флюидов - $Q$ - дебит, объемный расход флюидов, $f_w$ - обводненность, $R_p$ - газовый фактор. В функциях свойств потока используется префикc \mintinline{vb.net}{MF_}.

Параметры потока, такие как расход ГЖС, доля газа в потоке, вязкость ГЖС важны для расчета и анализа работы скважин и скважинного оборудования.


\subsection{MF\_qmix\_m3day – расход газожидкостной смеси}

Функция позволяет рассчитать объемный расход газожидкостной смеси при заданных термобарических условиях. Объемный расход ГЖС важен например для подбора УЭЦН в скважине, так как именно определяет в какой точке характеристики УЭЦН будет работать. При наличии свободного газа в потоке расход ГЖС может быть значительно больше расхода жидкости на поверхности фиксируемого расходомером.
$$Q_{mix,rc} = Q_{w,sc} B_w(P,T) + Q_{o,sc} B_o(P,T)  + Q_{o,sc}  (R_p - R_s(P,T)) B_g(P,T) $$

Расход ГЖС определяется как сумма расходов отдельных фаз, приведенных к соответствующим термобарическим условиям, с учетом того, что часть газа будет растворена в нефти.

\putlisting{listings/MF_q_mix_rc_m3day.lst}

\subsection{MF\_rhomix\_kgm3 – плотность газожидкостной смеси}

Функция позволяет рассчитать плотность газожидкостной смеси при заданных термобарических условиях. 
$$\rho_{mix,rc} = \left( \frac{\rho_{w,sc}}{B_w} f_w + \frac{\rho_{o,sc} +r_s \rho_{g,sc} }{B_o}(1-f_w) \right) (1-f_g) + \frac{ \rho_{g,sc} }{B_g} f_g $$

\putlisting{listings/MF_Rhomix_kgm3.lst}

\subsection{MF\_gas\_fraction\_d – доля газа в потоке}

Функция расчёта доли свободного газа в потоке (без учёта проскальзывания) в зависимости от термобарических условий для заданного флюида. 
$$f_g = \frac{Q_{g,rc}}{Q_{mix,rc}} $$
Доля газа в потоке является одним из ключевых параметров ограничивающих производительность систем механизированной добычи - ЭЦН и других насосов.

\putlisting{listings/MF_gas_fraction_d.lst}

\subsection{MF\_p\_gas\_fraction\_atma – целевое давления для заданной доли газа в потоке}
Функция расчёта давления при котором достигается заданная доля свободного газа в потоке (без учёта проскальзывания). 
Значение давления при котором достигается определённая доля газа в потоке может быть найдено из решения уравнения, определяющего долю газа. 
$$f_g = \frac{Q_{g,rc}(P,T)}{Q_{mix,rc}(P,T)} $$
Решение в \unf реализовано итеративное, методом деления отрезка пополам (дихотомия). При вызове функции пересчитывается состояние смеси с различными термобарическими условиями. Поэтому расчёт проводится относительно медленно. 

\putlisting{listings/MF_p_gas_fraction_atma.lst}

\subsection{MF\_rp\_gas\_fraction\_m3m3 – целевой газовый фактор для заданной доли газа в потоке}
Функция расчёта газового фактора $R_p$ при котором достигается заданная доля свободного газа в потоке (без учёта проскальзывания) . 
Значение давления при котором достигается определённая доля газа в потоке может быть найдено из решения уравнения, определяющего долю газа. 
$$f_g = \frac{Q_{g,rc}(P,T,R_p)}{Q_{mix,rc}(P,T,R_p)} $$
Решение в \unf реализовано итеративное, методом деления отрезка пополам (дихотомия). При вызове функции пересчитывается состояние смеси с различными термобарическими условиями. Поэтому расчёт проводится относительно медленно. 

\putlisting{listings/MF_rp_gas_fraction_m3m3.lst}

\section{Сепарация газа в скважине}
В скважинах оборудованных системами механизированной добычи нефти важную роль играет процесс сепарации газа на приёме насоса. Под сепарацией газа понимается отделение части свободного газа из потока и перенаправление его по отдельному гидравлическому каналу на поверхность. В результате сепарации газа меняются свойства флюида, поступающего в насос и НКТ выше насоса. Оценка величины сепарации может быть проведена приведёнными ниже функциями.

\subsection{MF\_ksep\_natural\_d – естественная сепарация газа}
Функция рассчитывает естественную сепарацию газа на приёме насоса в скважине с использованием корреляции Маркеса \cite{Marquez_2003} . Результат - безразмерная величина в диапазоне от 0 до 1. 

\putlisting{listings/MF_ksep_natural_d.lst}

\subsection{MF\_ksep\_gasseparator\_d – сепарация газа роторным газосепаратором}
Функция рассчитывает сепарацию газа с использованием роторного газосепаратора, являющегося обычно частью компоновки УЭЦН. Данный расчет основан на результатах испытания характеристик роторных газосепараторов, выполненных в РГУ нефти и газа имени И.М.Губкина \cite{SPE_117415_2008}. 

Следует отметить, что несмотря на хорошее соответствие промысловых исследований и расчетов с использованием корреляции для естественной и искусственной сепарации \cite{SPE_117415_2008} к результатам стендовых исследований стоит относится с осторожностью. Основой осторожности могут быть следующие соображения: характеристики различных газосепараторов достаточно сильно отличаются друг от друга - есть удачные конструкции и не очень, при этом результаты стендовых испытаний доступны только для ограниченного набора конструкций, стендовые условия достаточно сильно отличаются от скважинных - ниже давление, другие модельные рабочие жидкости, точно оценить коэффициент сепарации газосепаратора в промысловых условиях затруднительно - набор таких данных для сравнения ограничен. 

Тем не менее изучение результатов стендовых испытаний полезно при проведении расчетов и развивает инженерную интуицию. 

\putlisting{listings/MF_ksep_gasseparator_d.lst}


\subsection{MF\_ksep\_total\_d – общая сепарация газа}

Функция рассчитывает полную сепарацию газа на приёме насосе в скважине по известным значениям естественной сепарации газа и коэффициента сепарации газосепаратора. Результат - безразмерная величина в диапазоне от 0 до 1. 

$$K_{sep\_total} = K_{sep\_nat} + (1-K_{sep\_nat}) K_{sep\_gassep}$$

\putlisting{listings/MF_ksep_total_d.lst}

\section{Расчёт многофазного потока в штуцере}


Штуцер или локальное гидравлическое сопротивление - элемент скважины или системы трубопроводов, применяемых для создания дополнительного перепада давления в системе и ограничения потока. 
Возможны различные варианты реализации штуцера - со штуцерной камерой, с угловым краном, позволяющим менять диаметр штуцера и другие.
Ключевым параметром штуцера является диаметр \(d_{choke} \) определяющий его способность к ограничению потока. 

\begin{figure}[h!]
	\begin{center}
	    \input{draw/choke_scheme}
		\caption{Схема локального гидравлического сопротивления - штуцера}
		\label{ris:Pipe_choke}
	\end{center}
\end{figure}

Как и у любого элемента гидравлического потока есть три ключевых параметра - давление на входе \( P_{in} \), давление на выходе \(P_{out}\)  и расход газожидкостной смеси, обычно задаваемый в стандартных условиях \(Q_{liq} \). Задание любых двух элементов позволяет вычислить третий. При задании трех элементов модель штуцера может быть настроена на замеры за счёт подбора калибровочного параметра.

Следует обратить внимание, расчёт перепада давления в штуцере сильно зависит от направления расчета. При фиксированном давлении на выходе $P_{out}$, что для скважины и штуцера на устье соответствует заданному давлению в линии, для любого расхода ГЖС через штуцер можно найти соответствующее значение давления на входе \ref{ris:choke_out_curves}.
 
\begin{figure}[h!]
	
	\begin{center}
		
		\newcommand{\dPipeDataFile}{data/choke1.prn}
		\begin{tikzpicture}[scale=1]
		\begin{axis}[
		width=14cm,
		height=8cm,
		xlabel=$Q\; m^3 / day$,
		ylabel=$P_{in} \; atma$,
		legend pos=south east,
		title=Перепад давления в штуцере]
		\addplot table [y=Pout_1, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{out}=1$}
		\addplot table [y=Pout_5, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{out}=5$}
		\addplot table [y=Pout_10, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{out}=10$}
		\addplot table [y=Pout_15, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{out}=15$}
		\addplot table [y=Pout_20, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{out}=20$}
		\addplot table [y=Pout_30, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{out}=30$}
		\end{axis}
		\end{tikzpicture}
		
		
		\caption{Кривые зависимости давления на входе в штуцер от дебита при фиксированном давлении на выходе из штуцера $P_{out}$}
		\label{ris:choke_out_curves}
		
	\end{center}
\end{figure} 

А вот при фиксированном давлении на входе $P_{in}$ или фиксированном буферном давлении $P_{buf}$ не для всякого расхода ГЖС можно рассчитать давление на выходе \ref{ris:choke_in_curves}. При фиксированном давлении на входе $P_{in}$ существует максимальный расход ГЖС, который можно прокачать через штуцер с заданным диаметром проходного канала. Такой расход называется критическим. При критическом расходе в канале штуцера скорость потока достигает скорости звука и давление на входе перестает зависеть от давления за штуцером. Величина критического расхода через штуцер зависит от давления на входе, поскольку с повышением давления увеличивается скорость звука в среде.

Вертикальная линия на графике зависимости давления на выходе $P_{out}$ от дебита при критическом расходе показывает, что давление не определяется однозначно, а может принимать любое значение на вертикальной линии. Подобная неоднозначность расчетного давления на выходе штуцера может осложнять расчеты и должна учитываться инженером разрабатывающим расчетный модуль или проводящим расчёты.

\begin{figure}[h!]
	
	\begin{center}
		
		\newcommand{\dPipeDataFile}{data/choke2.prn}
		\begin{tikzpicture}[scale=1]
		\begin{axis}[
		width=14cm,
		height=8cm,
		xlabel=$Q\; m^3 / day$,
		ylabel=$P_{out} \; atma$,
		legend pos=south east,
		title=Перепад давления в штуцере]
		\addplot table [y=Pin_10, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{in}=10$}
		\addplot table [y=Pin_15, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{in}=15$}
		\addplot table [y=Pin_20, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{in}=20$}
		\addplot table [y=Pin_25, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{in}=25$}
		\addplot table [y=Pin_30, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{in}=30$}
		\addplot table [y=Pin_35, x=Q]{\dPipeDataFile};
		\addlegendentry{$P_{in}=35$}
		\end{axis}
		\end{tikzpicture}
		
		
		\caption{Кривые зависимости давления на выходе из штуцера от дебита при фиксированном давлении на входе в штуцер $P_{in}$}
		\label{ris:choke_in_curves}
		
	\end{center}
\end{figure} 

Функции расчета штуцера позволяют настроить модель штуцера на замерные данные. Настройка проводится за счет параметра калибровки $c_{calibr}$ \mintinline{vb.net}{c_calibr_fr}. 
Параметр калибровки $c_{calibr}$ применяется как множитель на дебит при расчете характеристики штуцера. 
$$Q_{real} = Q_{calc} * c_{calibr}$$
Таким образом $c_{calibr}=1$ отключает калибровку. А изменение $c_{calibr}$ позволит изменить характеристику штуцера для согласования с измерениями \ref{ris:choke_cal_curves}.

\begin{figure}[h!]
	
	\begin{center}
		
		\newcommand{\dPipeDataFile}{data/choke3.prn}
		\begin{tikzpicture}[scale=1]
		\begin{axis}[
		width=14cm,
		height=6cm,
		xlabel=$Q\; m^3 / day$,
		ylabel=$P_{out} \; atma$,
		legend pos=south west,
		title=Пример калибровки модели штуцера]
		\addplot table [y=cal_1, x=Q]{\dPipeDataFile};
		\addlegendentry{$c_{calibr}=1$}
		\addplot table [y=cal_1.2, x=Q]{\dPipeDataFile};
		\addlegendentry{$c_{calibr}=1.2$}
		\end{axis}
		\end{tikzpicture}
		
		
		\caption{Кривые зависимости давления на выходе из штуцера от дебита при фиксированном давлении на входе в штуцер $P_{in}$}
		\label{ris:choke_cal_curves}
		
	\end{center}
\end{figure}  

Все функции для расчета штуцера содержат в названии слово \mintinline{vb.net}{choke}.  

\subsection{MF\_p\_choke\_atma – Расчет давления на входе или на выходе штуцера}
Функция позволяет рассчитать давление на входе или выходе штуцера по известному давлению на противоположном конце при известных параметрах потока (дебите жидкости, обводнённости, газовому фактору). Расчёт проводится по корреляции Перкинса \cite{Perkins_1993} с учётом многофазного потока. 
 
\putlisting{listings/MF_p_choke_atma.lst}

%\subsection{MF\_dp\_choke\_atm – Расчёт перепада давления в штуцере}
%Функция позволяет рассчитать по известному линейному давлению и дебиту или по известному буферному давлению и дебиту перепад давления.  Расчет проводится по корреляции Перкинса \cite{Perkins_1993} с учетом многофазного потока.  
%Функция возвращает перепад давления и температуры в виде массива.
%\putlisting{listings/MF_dp_choke_atm.lst}


\subsection{MF\_qliq\_choke\_sm3day – функция расчёта дебита жидкости через штуцер}
Функция позволяет рассчитать по известному буферному давлению и линейному давлению дебит жидкости. Расчет проводится по корреляции Перкинса \cite{Perkins_1993} с учетом многофазного потока.  

\putlisting{listings/MF_qliq_choke_sm3day.lst}


\subsection{MF\_calibr\_choke\_fr – функция настройки модели штуцера}
Функция позволяет рассчитать корректирующий фактор для модели штуцера, позволяющий согласовать результаты замеров давления и дебита. Расчет проводится по корреляции Перкинса \cite{Perkins_1993} с учетом многофазного потока.  

\putlisting{listings/MF_calibr_choke_fr.lst}

\newpage
\section{Расчет многофазного потока в трубе}

Для расчета участка трубы с использованием пользовательских функций Унифлок применяется следующая схема - \ref{ris:Pipe_scheme_1}.

Участок трубы задается как прямой с постоянным наклоном $\theta$  длиной $L$, постоянного диаметра $d$. Поток движется под углом $\theta$ к горизонтальной плоскости. Угол  $\theta$ меняется от -90 до 90 градусов Цельсия. Отрицательная величина  $\theta < 0 $ означает, что поток движется вниз - например отрицательным будет угол наклона для нагнетательной скважины. Угол наклона $\theta = 0 $ соответствует потоку в горизонтальном участке трубопровода.

Труба имеет постоянную по всей длине шероховатость стенок. 

\begin{figure}[h!]
	\begin{center}
		\input{draw/pipe_segment.tex}
		\caption{Схема трубы принятая для расчётов с использованием пользовательских функций}
		\label{ris:Pipe_scheme_1}
	\end{center}
\end{figure}

Для расчёта распределения давления в трубе необходимо задать граничное значение давления на одном из концов трубы. Граничное давление всегда задается параметром  \mintinline{vb.net}{Pcalc_atma}. Температура потока в точке, где задается давление, задается параметром  \mintinline{vb.net}{T_calc_C}.  Возможно два варианта задания условия - по потоку  \ref{ris:Pipe_scheme_2}  \mintinline{vb.net}{calc_along_flow=1}. и против потока  \ref{ris:Pipe_scheme_3} \mintinline{vb.net}{calc_along_flow=0}. 

\begin{figure}[h!]
	\begin{center}
		\input{draw/pipe_segment_up.tex}		
		\caption{Схема расчёта распределения давления по потоку \mintinline{vb.net}{calc_along_flow=1}}
		\label{ris:Pipe_scheme_2}
	\end{center}
\end{figure} 

Схема расчета распределения давления по потоку для случая вертикальной добывающей скважины соответствует расчету распределения давления "снизу вверх" - от забойного давления к устьевому.

\begin{figure}[h!]
	\begin{center}
		\input{draw/pipe_segment_down.tex}
		\caption{Схема расчета распределения давления против потока \mintinline{vb.net}{calc_along_flow=0}}
		\label{ris:Pipe_scheme_3}
	\end{center}
\end{figure} 

Схема расчета распределения давления против потока для случая вертикальной добывающей скважины соответствует расчету распределения давления "сверху вниз" - от устьевого давления к забойному.

\subsection{MF\_dp\_pipe\_atm – расчёт перепада давления в трубе}

Функция позволяет рассчитать перепад давления в участке трубопровода. 
Функция возвращает давление и температуру в виде массива.

\putlisting{listings/MF_dp_pipe_atm.lst}

Ниже на рисунке приведены результаты расчёта кривой оттока (перепада давления в вертикальной трубе) для различных корреляций, реализованных в \unf{}.

\begin{figure}[h!]
	
\begin{center}

\newcommand{\dPipeDataFile}{data/dPipe.txt}
\begin{tikzpicture}[scale=1]
\begin{axis}[
width=14cm,
height=10cm,
xlabel=$Q\; m^3 / day$,
ylabel=$P_{wf} \; atma$,
legend pos=south east,
title=Pipe Pressure Drop]
\addplot table [y=P_0, x=Q]{\dPipeDataFile};
\addlegendentry{Beggs Brill}
\addplot table [y=P_1, x=Q]{\dPipeDataFile};
\addlegendentry{Ansari}
\addplot table [y=P_2, x=Q]{\dPipeDataFile};
\addlegendentry{Unified}
\addplot table [y=P_3, x=Q]{\dPipeDataFile};
\addlegendentry{Gray}
\addplot table [y=P_4, x=Q]{\dPipeDataFile};
\addlegendentry{Hagedorn Brown}
\addplot table [y=P_5, x=Q]{\dPipeDataFile};
\addlegendentry{Sakharov Mokhov}
\end{axis}
\end{tikzpicture}


	\caption{Кривые характеристики многофазного потока для вертикальных труб рассчитанные с использованием различных корреляций }
\label{ris:VLP_curves}

\end{center}
\end{figure}

\subsection{MF\_p\_pipe\_atma – функция расчета давления на конце трубы}  

\putlisting{listings/MF_p_pipe_atma.lst}

\subsection{MF\_p\_pipe\_znlf\_atma – функция расчета давления на конце трубы при барботаже}  

\putlisting{listings/MF_p_pipe_znlf_atma.lst}

\subsection{MF\_dpdl\_atmm – функция расчета градиента давления по многофазной корреляции}  

\putlisting{listings/MF_dpdl_atmm.lst}

\newpage

