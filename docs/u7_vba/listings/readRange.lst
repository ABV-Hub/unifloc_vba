' функция кодирования параметров работы скважины с газлифтом
Public Function WellGL_encode_string( _
                    Optional ByVal Hperf_m As Double = 2000, _
                    Optional ByVal Htub_m As Double = 1800, _
                    Optional ByVal Udl_m As Double = 0, _
                    Optional ByVal dCas_mm As Double = 150, _
                    Optional ByVal dTub_mm As Double = 72, _
                    Optional ByVal dChoke_mm As Double = 15, _
                    Optional ByVal roughness_m As Double = 0.0001, _
                    Optional ByVal Tbh_C As Double = 85, _
                    Optional ByVal Twh_C As Double = 25, _
                    Optional HmesGLV_m = 0, _
                    Optional dGLV_mm = 0, _
                    Optional PsurfGLV_atma = 0)
' функция кодирования значений PVT в строку, которую можно потом использовать
    Dim str As String
    Dim frmt As String
    Dim frmt_int As String
    
    Dim H_glv_m() As Variant
    Dim d_glv_mm() As Variant
    Dim p_glv_atma() As Variant
    
    frmt = "#0.####0"
    frmt_int = "0"
    str = ""
    str = str & "Hperf_m:" & Format(Hperf_m, frmt) & ";"
    str = str & "Htub_m:" & Format(Htub_m, frmt) & ";"
    str = str & "Udl_m:" & Format(Udl_m, frmt) & ";"
    str = str & "dCas_mm:" & Format(dCas_mm, frmt) & ";"
    str = str & "dTub_mm:" & Format(dTub_mm, frmt) & ";"
    str = str & "dchoke_mm:" & Format(dChoke_mm, frmt) & ";"
    str = str & "roughness_m:" & Format(roughness_m, frmt) & ";"
    str = str & "Tbh_C:" & Format(Tbh_C, frmt) & ";"
    str = str & "Twh_C:" & Format(Twh_C, frmt) & ";"
    
    H_glv_m = readRange(HmesGLV_m)
    d_glv_mm = readRange(dGLV_mm)
    p_glv_atma = readRange(PsurfGLV_atma)
    
    Dim i As Integer
    If (UBound(H_glv_m) = UBound(d_glv_mm)) And (UBound(H_glv_m) = UBound(p_glv_atma)) Then
        str = str & "GLV:" & FormatInteger(UBound(H_glv_m)) & ";"
        For i = LBound(H_glv_m) To UBound(H_glv_m)
            str = str & "H_glv_m:" & FormatFReal(Cdbl_(H_glv_m(i))) & ";"
            str = str & "d_glv_mm:" & FormatFReal(Cdbl_(d_glv_mm(i))) & ";"
            str = str & "p_glv_atma:" & FormatFReal(Cdbl_(p_glv_atma(i))) & ";"
        Next i
    Else
        str = str & "GVL:0;error" & ";"
    End If
    
    WellGL_encode_string = str
    
End Function
Private Function readRange(rr)
    Dim ar() As Variant
    Dim arout() As Variant
        Dim i As Integer
        Dim j As Integer
On Error GoTo err1:
    If (TypeOf rr Is Range) Or IsArray(rr) Then
        If (TypeOf rr Is Range) Then
            If rr.Cells.Count = 1 Then
                ReDim ar(1 To 1, 1 To 1)
                ar(1, 1) = rr.Value
            Else
                ar = rr.Value
            End If
            j = 0
            For i = LBound(ar) To UBound(ar)
                If Not IsEmpty(ar(i, 1)) Then
                    j = j + 1
                    ReDim Preserve arout(1 To j)
                    arout(j) = ar(i, 1)
                End If
            Next i
        Else
            ReDim arout(LBound(rr) To UBound(rr))
            For i = LBound(rr) To UBound(rr)
                arout(i) = rr(i)
            Next i
        End If
    Else
        ReDim arout(1 To 1, 1 To 1)
        arout(1, 1) = rr
    End If
    readRange = arout
    Exit Function
err1:
    readRange = "error"
End Function
