'=======================================================================================
'Unifloc7.2  Canis Lupus                                          khabibullinra@gmail.com
'Библиотека расчетных модулей по нефтяному инжинирингу
'2000 - 2017 г
'
'=======================================================================================
' функции для проведения расчетов из интерфейса Excel
Option Explicit
' переменные для оптимизации работы интерфейсных функций с базой ЭЦН
' должны позволить сохранить данные загруженные из базы для работы тестов и макросов
Public Function StartLog()
End Function
' функция расчета объемного коэффициента газа
Public Function PVT_Bg_m3m3(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
' выходное значение - число - объемный коэффициент газа
'          при заданных термобарических условиях, м3/м3.
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
      
          
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Bg_m3m3 = PVT.Bg_m3m3
End Function
' расчет объемного коэффициента нефти
Public Function PVT_Bo_m3m3(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
' выходное значение - число - объемный коэффициент газа
'          при заданных термобарических условиях, м3/м3.
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
          
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Bo_m3m3 = PVT.Bo_m3m3
End Function
' расчет объемного коэффициента воды
Public Function PVT_Bw_m3m3(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
' выходное значение - число - объемный коэффициент газа
'          при заданных термобарических условиях, м3/м3.
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
          
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Bw_m3m3 = PVT.Bw_m3m3
End Function
' расчет вязкости нефти
Public Function PVT_Muo_cP(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
 '       Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
          
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Muo_cP = PVT.Muo_cP
End Function
' расчет вязкости газа
Public Function PVT_Mug_cP(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
 '       Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
          
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Mug_cP = PVT.Mug_cP
End Function
' расчет вязкости воды
Public Function PVT_Muw_cP(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
 '       Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
          
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Muw_cP = PVT.Muw_cP
End Function
' расчет газосодержания
Public Function PVT_Rs_m3m3(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Rs_m3m3 = PVT.rs_m3m3
End Function
' расчет коэффициента сверхсжимаемости газа
Public Function PVT_Z(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
    
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Z = PVT.z
End Function
' расчет плотности нефти
Public Function PVT_Rhoo_kgm3(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Rhoo_kgm3 = PVT.rho_oil_kgm3
End Function
' расчет плотности газа
Public Function PVT_Rhog_kgm3(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Rhog_kgm3 = PVT.rho_gas_kgm3
End Function
' расчет плотности воды
Public Function PVT_Rhow_kgm3(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Rhow_kgm3 = PVT.rho_water_kgm3
End Function
' расчет доли газа в потоке
Public Function MF_GasFraction_d(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional wc_perc = 0, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    ) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
'
'  выходное значение - число - доля газа в потоке
' (расходная без проскальзования), м3/м3.
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
    PVT.wc_perc = wc_perc
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    MF_GasFraction_d = PVT.GasFraction_d(0)
End Function
' расчет давления при котором достигается заданная доля газа в потоке
Public Function MF_PGasFraction_atma(FreeGas_d, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional wc_perc = 0, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1 _
                    ) As Double
' обязательные аргументы функции
' FreeGas_d допустимая доля газа в потоке
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
' выходное значение - число - давление, атма.
    Dim PVT As New CPVT
    Dim t As Double
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
    PVT.wc_perc = wc_perc
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    
    'Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    t = T_C
    MF_PGasFraction_atma = PVT.PGasFraction_atma(FreeGas_d, t)
End Function
' расчет газового фактора при котором достигается заданная доля газа в потоке
Public Function MF_RpGasFraction_m3m3(FreeGas_d, P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional wc_perc = 0, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1 _
                    ) As Double
' обязательные аргументы функции
' FreeGas_d допустимая доля газа в потоке
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
' выходное значение - число - давление, атма.
    Dim PVT As New CPVT
    Dim t As Double, P As Double
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
    PVT.wc_perc = wc_perc
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    
    'Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    t = T_C
    P = P_atma
    MF_RpGasFraction_m3m3 = PVT.RpGasFraction_m3m3(FreeGas_d, P, t)
End Function
' Расчет давления насыщения
Public Function PVT_Pb_atma(T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pbcal_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1 _
                    ) As Double
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
' выходное значение - число - давление насыщения.
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pbcal_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
          
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    
   ' Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Pb_atma = PVT.Calc_Pb_atma(rsb_m3m3, T_C)
End Function
' расчет объемного расхода газожидкостной смеси для заданных термобарических условий
Public Function PVT_Qmix_m3day(Qliq_m3day, wc_perc, P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1 _
                    ) As Double
' обязательные аргументы функции
' Qliq_m3day - дебит жидкости на поверхности
' wc_perc - объемная обводненность
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
' выходное значение - число - объемный расход ГЖС, м3/сут.
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
    PVT.wc_perc = wc_perc
    PVT.Qliq_scm3day = Qliq_m3day
    
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
 '       Call PVT.Calc_PVT(PinKsep_atma, TinKsep_C)
 '       Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
          
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Qmix_m3day = PVT.Qmix_m3day
End Function
' расчет плотности газожидкостной смеси для заданных термобарических условий
Public Function PVT_Rhomix_kgm3(Qliq_m3day, wc_perc, P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1 _
                    ) As Double
' обязательные аргументы функции
' Qliq_m3day - дебит жидкости на поверхности
' wc_perc - объемная обводненность
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
' выходное значение - число - объемный расход ГЖС, м3/сут.
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
    PVT.wc_perc = wc_perc
    PVT.Qliq_scm3day = Qliq_m3day
    
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
 '       Call PVT.Calc_PVT(PinKsep_atma, TinKsep_C)
 '       Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
          
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Rhomix_kgm3 = PVT.rho_mix_kgm3
End Function
' расчет вязкости газожидкостной смеси для заданных термобарических условий
Public Function PVT_Mumix_cP(Qliq_m3day, wc_perc, P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1 _
                    ) As Double
' обязательные аргументы функции
' Qliq_m3day - дебит жидкости на поверхности
' wc_perc - объемная обводненность
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
'
' выходное значение - число - объемный расход ГЖС, м3/сут.
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
    PVT.wc_perc = wc_perc
    PVT.Qliq_scm3day = Qliq_m3day
    
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
 '       Call PVT.Calc_PVT(PinKsep_atma, TinKsep_C)
 '       Qgfree = PVT.Qgas_cas_scm3day(Ksep_fr)
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
          
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Mumix_cP = PVT.MuMix_cP
End Function
' расчет натуральной сепарации газа на приеме насоса
Public Function MF_SeparNat_d(Pin_atma As Double, _
        Qliq_m3day As Double, WCT_perc, _
        Optional Tin_C As Double = 50, _
        Optional dintake_mm As Double = 90, _
        Optional Dcas_mm As Double = 120, _
        Optional gamma_gas = const_gamma_gas_default, _
        Optional gamma_oil = const_gamma_oil_default, _
        Optional gamma_wat = const_gamma_wat_default, _
        Optional rsb_m3m3 = const_Rsb_default, _
        Optional Rp_m3m3 As Double = -1, _
        Optional Pb_atma As Double = -1, _
        Optional Tres_C As Double = const_Tres_default, _
        Optional Bob_m3m3 As Double = -1, _
        Optional Muob_cP As Double = -1, _
        Optional PVTcorr = StandingBased) As Double
'----------------------------------------------------------------
' Pin_atma       - давление сепарации
' Qliq_m3day    - дебит жидкости в поверхностных условиях
' WCT_perc      - обводненность
' Tin_C         - температура сепарации
' dintake_mm    - диаметр приемной сетки
' dcas_mm       - диаметр эксплуатационной колонны
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
    Dim Fluid As New CPVT
    Call Fluid.SetRpRsb(Rp_m3m3, CDbl(rsb_m3m3))
    Fluid.Pb_atma = Pb_atma
    Fluid.Tres_C = Tres_C
    Fluid.PVT_CORRELATION = PVTcorr
    Fluid.Bob_m3m3 = Bob_m3m3
    Fluid.gamma_g = gamma_gas
    Fluid.gamma_o = gamma_oil
    Fluid.gamma_w = gamma_wat
    
    Fluid.Qliq_scm3day = Qliq_m3day
    Fluid.wc_perc = WCT_perc
    
    Call Fluid.Calc_PVT(Pin_atma, Tin_C)
    With Fluid
        MF_SeparNat_d = unf_calc_natural_separation(dintake_mm / 1000, Dcas_mm / 1000, .Qliq_scm3day, .Qgas_scm3day, .Bo_m3m3, .Bg_m3m3, .sigma_o_Nm, .RhoOil_sckgm3, .rhoGas_sckgm3, .wc_perc)
    End With
    
End Function
Public Function MF_SeparTotal_d(SepNat As Double, _
                        SepGasSep As Double) As Double
' SepNat        - естественная сепарация
' SepGasSep     - искуственная сепарация (газосепаратор)
    MF_SeparTotal_d = SepNat + (1 - SepNat) * SepGasSep
End Function
Public Function MF_PrGrad(ByVal d_m As Double, _
             ByVal P_atma As Double, _
             ByVal Ql_rc_m3day As Double, _
             ByVal Qg_rc_m3day As Double, _
            Optional ByVal Muo_cP As Double = const_mu_o, _
            Optional ByVal Mug_cP As Double = const_mu_g, _
            Optional ByVal sigma_o_Nm As Double = const_sigma_oil_Nm, _
            Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
            Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
            Optional ByVal eps_m As Double = 0.0001, _
            Optional ByVal theta_deg As Double = 90, _
            Optional ByVal ZNLF As Boolean = False)
' расчет градиента давления по одной из корреляций
' объемные коэффициенты по умолчанию заданы равными единицам - если их не трогать, значит дебиты в рабочих условиях
' газосодержание равно нулю по умолчанию - значит весь газ который указан идет в потоке
' пока только для Ансари - потом можно распространить и на другие методы
Dim rho_osc_kgm3 As Double
Dim rho_gsc_kgm3 As Double
Dim dPdLg_out_atmm As Double
Dim dPdLf_out_atmm As Double
Dim Vsl_out_msec As Double
Dim Vsg_out_msec As Double
Dim Hl_out_fr As Double
Dim fpat_out_num
Dim dPdLa_out_atmm As Double
Dim PrGrad
rho_osc_kgm3 = gamma_oil * const_rho_ref
rho_gsc_kgm3 = gamma_gas * const_rho_air
On Error GoTo er1:
    PrGrad = unf_AnsariGradient(d_m, theta_deg, eps_m, _
                                Ql_rc_m3day, Qg_rc_m3day, _
                                Muo_cP, Mug_cP, _
                                sigma_o_Nm, _
                                rho_osc_kgm3, _
                                rho_gsc_kgm3, _
                                P_atma)
    
    MF_PrGrad = PrGrad
    
Exit Function
er1:
MF_PrGrad = 0
End Function
'  расчет перепада давления и распределения температуры в трубе
'  с использованием многофазных корреляций
Public Function MF_dPpipe_atma(Q_m3Day, WCT_perc, _
                Hmes0_m As Double, Hmes1_m As Double, _
                Pcalc_atma As Double, _
                Optional Tcalc_C As Double = 50, _
                Optional theta_deg As Double = 90, _
                Optional d_mm As Double = 60, _
                Optional roughness_m As Double = 0.0001, _
                Optional gamma_gas = const_gamma_gas_default, _
                Optional gamma_oil = const_gamma_oil_default, _
                Optional gamma_wat = const_gamma_wat_default, _
                Optional rsb_m3m3 = const_Rsb_default, _
                Optional Rp_m3m3 As Double = -1, _
                Optional Pb_atma As Double = -1, _
                Optional Tres_C As Double = const_Tres_default, _
                Optional Bob_m3m3 As Double = -1, _
                Optional Muob_cP As Double = -1, _
                Optional PVTcorr = StandingBased, _
                Optional Ksep_fr As Double = 0, _
                Optional PKsep_atma As Double = -1, _
                Optional TKsep_C As Double = -1, _
                Optional HydrCorr As H_CORRELATION = 0, _
                Optional Tother_C As Double = -1, _
                Optional betta_grav = 1, Optional betta_fric = 1)
'
' Обязательные параметры
' Q_m3Day       - дебит жидкости в поверхностных условиях
' WCT_perc      - обводненность
' Hmes0_m       - начальная координата трубы, м
' Hmes1_m       - конечная координата трубы, м
'                 расчет всегда ведется от начальной координаты к
'                 конечной. если Hmes0_m < Hmes1_m то расчет
'                 идет сверху вниз для вертикальной трубы
'                 иначе расчет идет снизу вверх
' Pcalc_atma    - давление с которого начинается расчет, атм
'                 граничное значение для проведения расчета
' Необязательные параметры
' стандартные набор PVT параметров
' Tcalc_C       - температура в точке где задано давление, С
' theta_deg     - угол направления потока к горизонтали
'                 (90 - вертикальная труба вверх)
'                 может принимать отрицательные значения
' d_mm          - внутрнний диаметр трубы
' roughness_m   - шероховатость трубы
' gamma_gas     - удельная плотность газа, по воздуху.
'                   const_gamma_gas_default = 0.6
' gamma_oil     - удельная плотность нефти, по воде.
'                   const_gamma_oil_default = 0.86
' gamma_wat     - удельная плоность воды, по воде.
'                   const_gamma_wat_default = 1
' Rsb_m3m3      - газосодержание при давлении насыщения, м3/м3.
'                   const_Rsb_default = 100
' Rp_m3m3       - замерной газовый фактор, м3/м3.
' Pb_atma       - давление насыщения, атм. Калибровочный параметр.
' Tres_C        - пластовая температура, С.
'                 Учитывается при расчете давления насыщения.
' Bob_m3m3      - объемный коэффициент нефти, м3/м3.
' Muob_cP       - вязкость нефти при давлении насыщения
'                 По умолчанию рассчитывается по корреляции
' PVTcorr       - номер набора PVT корреляций для расчета
'                 StandingBased = 0 - на основе кор-ии Стендинга
'                 McCainBased = 1 - на основе кор-ии Маккейна
'                 StraigthLine = 2 - упрощенные зависимости
' Ksep_fr       - коэффициент сепарации - определяет изменение
'               свойств нефти после сепарации  доли  газа.
'               изменение свойств нефти зависит от условий
'               сепарация газа, которые должны быть явно заданы
' PKsep_atma    - давление при которой была сепарация
' TKsep_C       - температура при которой была сепарация
' HydrCorr      - гидравлическая корреляция, H_CORRELATION
'                   BeggsBriilCor = 0
'                   AnsariCor = 1
'                   UnifiedCor = 2
'                   Gray = 3
'                   HagedornBrown = 4
'                   SakharovMokhov = 5
' Tother_C      - температура на другом конце трубы
'                 по умолчанию температура вдоль трубы постоянна
'                 если задано то меняется линейно по трубе
' выходное значение - число - давление на другом конце трубы atma.
On Error GoTo err1:
    Dim Pipe As New CPipe
    Dim PVT As New CPVT
    Dim PTcalc As PTtype
    Dim TM As TEMP_CALC_METHOD
    Dim h
    
    PVT.gamma_g = gamma_gas
    PVT.gamma_o = gamma_oil
    PVT.gamma_w = gamma_wat
    PVT.Tres_C = Tres_C
    Call PVT.SetRpRsb(Rp_m3m3, CDbl(rsb_m3m3))
    PVT.Pb_atma = Pb_atma
    PVT.Bob_m3m3 = Bob_m3m3
    PVT.Muob_cP = Muob_cP
    PVT.PVT_CORRELATION = PVTcorr
        
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    
    PVT.Qliq_scm3day = Q_m3Day
    PVT.wc_perc = WCT_perc
    Set Pipe.Fluid = PVT
    
    PTcalc.P_atma = Pcalc_atma
    PTcalc.T_C = Tcalc_C
    If Tother_C < 0 Then Tother_C = Tcalc_C
'    Tcalc_method = 0 ' todo временно отключены другие методы кроме линейного
'    Select Case Tcalc_method
'        Case 0: TM = StartEndTemp
'        Case 1: TM = GeoGradTemp
'        Case 2: TM = AmbientTemp
'    End Select
    ' до некоторого времени была путаница с распределением температуры по глубинам
    '       логика такая - координаты всегда начинаются от устья к забою, а поток нормальный идет от забоя к устью
    '       поэтому начало трубы это забой (по потоку), конец трубы это устье
    
'    If Calc_from_H0 Then
    If Hmes0_m < Hmes1_m Then
        Pipe.Param = ParamCalcFromTop(HydrCorr, TempMeth:=StartEndTemp)
        Pipe.InitTlinear Tcalc_C, Tother_C
'        Pipe.Tstart_C = Tother_C
'        Pipe.Tend_C = Tcalc_C
    Else
        h = Hmes0_m
        Hmes0_m = Hmes1_m
        Hmes1_m = h
        Pipe.Param = ParamCalcFromBottom(HydrCorr, TempMeth:=StartEndTemp)
        Pipe.InitTlinear Tother_C, Tcalc_C
'        Pipe.Tstart_C = Tcalc_C
'        Pipe.Tend_C = Tother_C
    End If
    Call Pipe.InitPipe(d_mm / 1000, Hmes0_m, Hmes1_m, theta_deg, roughness_m)
    Pipe.betta_grav = betta_grav
    Pipe.betta_fric = betta_fric
    MF_dPpipe_atma = ArrayOut(Pipe.Calc_dPipe(PTcalc, noCurves))
    
    Exit Function
err1:
    MF_dPpipe_atma = ArrayOut(SetPT(0, 0))
    addLogMsg ("ошибка при расчете dPipe")
End Function
''  расчет перепада давления в трубе  по потоку
'Public Function MF_dPpipeDown_atma(L_m As Double, Pin_atma, Q_m3Day, WCT_perc, _
'                    Optional Tin_C As Double = 50, Optional Tout_C As Double = 50, _
'                    Optional theta_deg As Double = 90, Optional d_mm As Double = 60, _
'                    Optional roughness_m As Double = 0.0001, _
'                    Optional gamma_gas = const_gamma_gas_default, Optional gamma_oil = const_gamma_oil_default, _
'                    Optional gamma_wat = const_gamma_wat_default, _
'                    Optional Rsb_m3m3 = const_Rsb_default, _
'                    Optional Rp_m3m3 As Double = -1, _
'                    Optional Pb_atma As Double = -1, _
'                    Optional Tres_C As Double = const_Tres_default, _
'                    Optional Bob_m3m3 As Double = -1, _
'                    Optional Muob_cP As Double = -1, _
'                    Optional PVTcorr = StandingBased, _
'                    Optional Ksep_fr As Double = 0, _
'                    Optional PKsep_atma As Double = -1, _
'                    Optional TKsep_C As Double = -1, _
'                    Optional HydrCorr As H_CORRELATION = 0, _
'                    Optional ZNLF As Boolean = False)
''
'' Обязательные параметры
'' L_m       - длина трубы
'' Pin_atma   - давление на входе в трубу
'' Q_m3Day   - дебит жидкости в поверхностных условиях
'' WCT_perc  - обводненность
''
'' Необязательные параметры
'' стандартные набор PVT параметров
'' Tin_C     - температура на входе в трубу
'' Tout_C    - температура на выходе из трубы
'' theta_deg - угол к горизонтали (90 - вертикальная труба)
'' d_mm      - внутрнний диаметр
'' roughness_m - шероховатость трубы
'' HydrCorr  - гидравлическая корреляция
'' ZNLF      - признака барботажа (поток газа в неподвижной жидкости)
''
''
'
'On Error GoTo err1:
'    Dim Pipe As New CPipe
'    Dim PVT As New CPVT
'    Dim Qgfree As Double
'    Dim PTin As PTtype
'    Dim PTout As PTtype
'    PVT.gamma_g = gamma_gas
'    PVT.gamma_o = gamma_oil
'    PVT.gamma_w = gamma_wat
'    PVT.Tres_C = Tres_C
'    Call PVT.SetRpRsb(Rp_m3m3, Rsb_m3m3)
'    PVT.Pb_atma = Pb_atma
'    PVT.PVT_CORRELATION = PVTcorr
'        Pipe.Param = ParamCalcFromBottom(HydrCorr, TempMeth:=StartEndTemp)
'    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
''        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
'    End If
'    PVT.Qliq_scm3day = Q_m3Day
'    PVT.wc_perc = WCT_perc
'    Set Pipe.Fluid = PVT
'
' '   Pipe.correlation = AnsariCor 'UnifiedCor ' BeggsBriilCor
' '   Pipe.correlation = HydrCorr
'
'    Pipe.InitPipe d_mm / 1000, L_m, theta_deg, roughness_m, Tin_C, Tout_C
'    PTin.P_atma = Pin_atma
'    PTin.T_C = Tin_C
'    If ZNLF = True Then
'        MF_dPpipeDown_atma = ArrayOut(Pipe.Calc_dPipeZNLF(PTin, Qgfree))
'    Else
'        MF_dPpipeDown_atma = ArrayOut(Pipe.Calc_dPipe(PTin))
'    End If
'    Exit Function
'err1:
'    MF_dPpipeDown_atma = ArrayOut(SetPT(0, 0))
'    addLogMsg ("ошибка при расчете dPipe")
'End Function
'
''  расчет перепада давления в трубе  против потока
'Public Function MF_dPpipeUp_atma(L_m As Double, Pout_atma, Q_m3Day, WCT_perc, _
'                    Optional Tin_C As Double = 50, Optional Tout_C As Double = 50, _
'                    Optional theta_deg As Double = 90, Optional d_mm As Double = 60, _
'                    Optional roughness_m As Double = 0.0001, _
'                    Optional gamma_gas = const_gamma_gas_default, _
'                    Optional gamma_oil = const_gamma_oil_default, _
'                    Optional gamma_wat = const_gamma_wat_default, _
'                    Optional Rsb_m3m3 = const_Rsb_default, _
'                    Optional Rp_m3m3 As Double = -1, _
'                    Optional Pb_atma As Double = -1, _
'                    Optional Tres_C As Double = const_Tres_default, _
'                    Optional Bob_m3m3 As Double = -1, _
'                    Optional Muob_cP As Double = -1, _
'                    Optional PVTcorr = StandingBased, _
'                    Optional Ksep_fr As Double = 0, _
'                    Optional PKsep_atma As Double = -1, _
'                    Optional TKsep_C As Double = -1, _
'                    Optional HydrCorr As H_CORRELATION = 0)
''
'' Обязательные параметры
'' L_m       - длина трубы
'' Pin_atma   - давление на входе в трубу
'' Q_m3Day   - дебит жидкости в поверхностных условиях
'' WCT_perc  - обводненность
''
'' Необязательные параметры
'' стандартные набор PVT параметров
'' Tin_C     - температура на входе в трубу
'' Tout_C    - температура на выходе из трубы
'' theta_deg - угол к горизонтали (90 - вертикальная труба)
'' d_mm      - внутрнний диаметр
'' roughness_m - шероховатость трубы
'' HydrCorr  - гидравлическая корреляция
''
''
'
'On Error GoTo err1:
'    Dim Pipe As New CPipe
'    Dim PVT As New CPVT
'    Dim Qgfree As Double
'    Dim PTin As PTtype
'    Dim PTout As PTtype
'    PVT.gamma_g = gamma_gas
'    PVT.gamma_o = gamma_oil
'    PVT.gamma_w = gamma_wat
'    PVT.Tres_C = Tres_C
'    Call PVT.SetRpRsb(Rp_m3m3, Rsb_m3m3)
'    PVT.Pb_atma = Pb_atma
'    PVT.PVT_CORRELATION = PVTcorr
'        Pipe.Param = ParamCalcFromTop(HydrCorr, TempMeth:=StartEndTemp)
'    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
''        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Call PVT.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
'    End If
'    PVT.Qliq_scm3day = Q_m3Day
'    PVT.wc_perc = WCT_perc
'    Set Pipe.Fluid = PVT
'
' '   Pipe.correlation = AnsariCor 'UnifiedCor ' BeggsBriilCor
' '   Pipe.correlation = HydrCorr
'
'    'Call Pipe.InitPipe(d_mm / 1000, Hm, theta_deg, roughness_m, Tout_C, Tin_C)
'    PTin.P_atma = Pout_atma
'    PTin.T_C = Tout_C
'    MF_dPpipeUp_atma = ArrayOut(Pipe.Calc_dPipe(PTin))
'    Exit Function
'err1:
'    MF_dPpipeUp_atma = ArrayOut(SetPT(0, 0))
'    addLogMsg ("ошибка при расчете dPipe")
'End Function
Private Function ArrayOut(PT As PTtype)
    ArrayOut = Array(PT.P_atma, PT.T_C)
End Function
' ==============  функции для расчета штуцера ==========================
' =====================================================================
'
' Расчет перепада давления в штуцере (по потоку)
Public Function MF_dPChoke_atm(dPipe_mm, dchoke_mm, _
            P0_atma, P1_atma, _
            Qliq_m3day, WCT_perc, _
            Optional Tchoke_C As Double = 20, _
            Optional Calc_from_P0 As Boolean = True, _
            Optional gamma_gas = const_gamma_gas_default, _
            Optional gamma_oil = const_gamma_oil_default, _
            Optional gamma_wat = const_gamma_wat_default, _
            Optional rsb_m3m3 = const_Rsb_default, _
            Optional Rp_m3m3 As Double = -1, _
            Optional Pb_atma As Double = -1, _
            Optional Tres_C As Double = const_Tres_default, _
            Optional Bob_m3m3 As Double = -1, _
            Optional Muob_cP As Double = -1, _
            Optional PVTcorr = StandingBased, _
            Optional Ksep_fr As Double = 0, _
            Optional PKsep_atma As Double = -1, _
            Optional TKsep_C As Double = -1)
' dPipe_mm      - диаметр трубы до и после штуцера
' dChoke_mm     - диаметр штуцера (эффективный)
' P0_atma       - давление на входе (высокой стороне)
' P1_atma       - давление на выходе (низкой стороне)
' Qliq_m3day    - дебит жидкости в пов условиях
' WCT_perc      - обводненность
' опциональные аргументы фукнции
' Tchoke_C      - температура, С.
' Calc_from_P0 - показывает направление расчета штуцера
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' выходное значение - число - перепад давления на штуцере.
    Dim choke As New Cchoke
    Dim PT As PTtype
    Call choke.Fluid.SetRpRsb(Rp_m3m3, CDbl(rsb_m3m3))
    choke.Fluid.Pb_atma = Pb_atma
    choke.Fluid.Tres_C = Tres_C
    choke.Fluid.PVT_CORRELATION = PVTcorr
    choke.Fluid.Bob_m3m3 = Bob_m3m3
    choke.Fluid.gamma_g = gamma_gas
    choke.Fluid.gamma_o = gamma_oil
    choke.Fluid.gamma_w = gamma_wat
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
        Call choke.Fluid.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, _
                                            Ksep_fr, GasGoesIntoSolution)
    End If
    choke.Fluid.Qliq_scm3day = Qliq_m3day
    choke.Fluid.wc_perc = WCT_perc
    
    choke.Ddown_m = dPipe_mm / 1000
    choke.Dup_m = dPipe_mm / 1000
    choke.Dchoke_m = dchoke_mm / 1000
    
    If Calc_from_P0 Then
        PT = choke.Calc_Choke_Plin(SetPT(P0_atma, Tchoke_C))
    Else
        PT = choke.Calc_Choke_Pbuf(SetPT(P1_atma, Tchoke_C))
    End If
    MF_dPChoke_atm = Array(PT.P_atma, PT.T_C)   ' на выходе выдаем массив
End Function
'' Расчет перепада давления в штуцере (против потока)
'Public Function MF_dPChokeUp_atma(dPipe_mm, dchoke_mm, Pdown_atma, Qliq_m3day, WCT_perc, _
'                        Optional Tchoke_C = 20, _
'                        Optional gamma_gas = const_gamma_gas_default, _
'                        Optional gamma_oil = const_gamma_oil_default, _
'                        Optional gamma_wat = const_gamma_wat_default, _
'                        Optional Rsb_m3m3 = const_Rsb_default, _
'                        Optional Rp_m3m3 As Double = -1, _
'                        Optional Pb_atma As Double = -1, _
'                        Optional Tres_C As Double = const_Tres_default, _
'                        Optional Bob_m3m3 As Double = -1, _
'                        Optional Muob_cP As Double = -1, _
'                        Optional PVTcorr = StandingBased, _
'                        Optional Ksep_fr As Double = 0, _
'                        Optional PKsep_atma As Double = -1, _
'                        Optional TKsep_C As Double = -1)
'
'' dPipe_mm      - диаметр трубы до и после штуцера
'' dChoke_mm     - диаметр штуцера (эффективный)
'' Pdown_atma     - давление на выходе (низкой стороне)
'' Qliq_m3day    - дебит жидкости в пов условиях
'' WCT_perc      - обводненность
'' данные PVT
'    Dim choke As New Cchoke
'    Dim PT As PTtype
'    Call choke.Fluid.SetRpRsb(Rp_m3m3, Rsb_m3m3)
'    choke.Fluid.Pb_atma = Pb_atma
'    choke.Fluid.Tres_C = Tres_C
'    choke.Fluid.PVT_CORRELATION = PVTcorr
'    choke.Fluid.Bob_m3m3 = Bob_m3m3
'    choke.Fluid.gamma_g = gamma_gas
'    choke.Fluid.gamma_o = gamma_oil
'    choke.Fluid.gamma_w = gamma_wat
'    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
''        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Call choke.Fluid.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
'    End If
'    choke.Ddown_m = dPipe_mm / 1000
'    choke.Dup_m = dPipe_mm / 1000
'    choke.Dchoke_m = dchoke_mm / 1000
'
'    choke.Fluid.Qliq_scm3day = Qliq_m3day
'    choke.Fluid.wc_perc = WCT_perc
'    PT = choke.Calc_Choke_Pbuf(SetPT(Pdown_atma, Tchoke_C))
'    MF_dPChokeUp_atma = Array(PT.P_atma, PT.T_C)   ' на выходе выдаем массив
'
'
'End Function
 ' функция расчета дебита жидкости через штуцер
Public Function MF_QChoke_m3day(dPipe_mm, dchoke_mm, Pup_atma, Pdown_atma, WCT_perc, _
                        Optional Tchoke_C = 20, _
                        Optional gamma_gas = const_gamma_gas_default, _
                        Optional gamma_oil = const_gamma_oil_default, _
                        Optional gamma_wat = const_gamma_wat_default, _
                        Optional rsb_m3m3 = const_Rsb_default, _
                        Optional Rp_m3m3 As Double = -1, _
                        Optional Pb_atma As Double = -1, _
                        Optional Tres_C As Double = const_Tres_default, _
                        Optional Bob_m3m3 As Double = -1, _
                        Optional Muob_cP As Double = -1, _
                        Optional PVTcorr = StandingBased, _
                        Optional Ksep_fr As Double = 0, _
                        Optional PKsep_atma As Double = -1, _
                        Optional TKsep_C As Double = -1)
' dPipe_mm      - диаметр трубы до и после штуцера
' dChoke_mm     - диаметр штуцера (эффективный)
' Pdown_atma     - давление на выходе (низкой стороне)
' Pup_atma       - давление на входе (высокой стороне)
' WCT_perc      - обводненность
' данные PVT
                       
    Dim choke As New Cchoke
    Call choke.Fluid.SetRpRsb(Rp_m3m3, CDbl(rsb_m3m3))
    choke.Fluid.Pb_atma = Pb_atma
    choke.Fluid.Tres_C = Tres_C
    choke.Fluid.PVT_CORRELATION = PVTcorr
    choke.Fluid.Bob_m3m3 = Bob_m3m3
    choke.Fluid.gamma_g = gamma_gas
    choke.Fluid.gamma_o = gamma_oil
    choke.Fluid.gamma_w = gamma_wat
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
        Call choke.Fluid.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    choke.Ddown_m = dPipe_mm / 1000
    choke.Dup_m = dPipe_mm / 1000
    choke.Dchoke_m = dchoke_mm / 1000
    
'    choke.Fluid.Qliq_scm3day = Qliq_m3day
    choke.Fluid.wc_perc = WCT_perc
    On Error GoTo er1:
    
    MF_QChoke_m3day = choke.Choke_liquid_rate(Pup_atma, Pdown_atma, Tchoke_C)
    Exit Function
er1:
    addLogMsg "QChoke_m3day: Расчет дебита через штуцер завершился с ошибкой Pup_atm=" & Pup_atma & " Pup_atma =" & Pdown_atma
    MF_QChoke_m3day = 0
    
End Function
' ==============  функции для расчета скважины ==========================
' =====================================================================
Private Function InitWellData(Q_m3Day, _
                      Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional Dcas_mm = 127, Optional dtub_mm = 62, Optional dchoke_mm = -1, _
                      Optional WCT_perc = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                      Optional gamma_oil = const_gamma_oil_default, Optional gamma_wat = const_gamma_wat_default, Optional gamma_gas = const_gamma_gas_default, _
                      Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
                      Optional roughness_m As Double = 0.0001, _
                      Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional esp_freq = 50, _
                      Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0, Optional Ksep_fr As Double = 0) As CWell
    Dim well As New CWell
    Dim PVT As New CPVT
    Dim pmp As CESPpump
    PVT.gamma_g = gamma_gas
    PVT.gamma_o = gamma_oil
    PVT.gamma_w = gamma_wat
    PVT.Tres_C = Tres_C
    Call PVT.SetRpRsb(Rp_m3m3, rsb_m3m3)
    PVT.Pb_atma = Pb_atma
    PVT.PVT_CORRELATION = PVTcorr
    PVT.Qliq_scm3day = Q_m3Day
    PVT.wc_perc = WCT_perc
    Set well.Fluid = PVT
    well.HFlowCorrelation = HydrCorr
    well.TempCorrelation = StartEndTemp ' AmbientTemp
    well.InitWell Hperf_m, Hpump_m, Udl_m, Dcas_mm, dtub_mm, Tbh_C, Twh_C
    well.choke.Dchoke_m = dchoke_mm / 1000
    well.choke.Ddown_m = dtub_mm / 1000
    well.choke.Dup_m = dtub_mm / 1000
    If ESP_ID > 0 Then
        If checkID(ESP_ID) Then
             Set pmp = getESP(ESP_ID)
             pmp.StageNum = ESP_numStages
             pmp.Frequency = esp_freq
             well.ESP.ClearESPumps
             well.ESP.AddESPpump pmp
             well.IsESP = True
        End If
    End If
    If Ksep_fr > 0 Then
        well.ESP.GasSeparator.KsepManual = True
        well.ESP.GasSeparator.Ksep_fr = Ksep_fr
    End If
    Set InitWellData = well
End Function
Public Function Well_Plin_Pwf_atma(Pwf_atma, Q_m3Day, _
                      Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional Dcas_mm = 127, Optional dtub_mm = 62, Optional dchoke_mm = -1, _
                      Optional WCT_perc = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                      Optional gamma_oil = const_gamma_oil_default, Optional gamma_wat = const_gamma_wat_default, Optional gamma_gas = const_gamma_gas_default, _
                      Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
                      Optional roughness_m As Double = 0.0001, _
                      Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional esp_freq = 50, _
                      Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0, Optional Ksep_fr As Double = 0, _
                      Optional Kdegr_d As Double = 0)
' функция расчета линейного давления скважины по забойному
    Dim well As CWell
    Set well = InitWellData(Q_m3Day, _
                       Hperf_m, Hpump_m, Udl_m, Dcas_mm, dtub_mm, dchoke_mm, _
                       WCT_perc, Rp_m3m3, rsb_m3m3, Pb_atma, Tres_C, _
                       gamma_oil, gamma_wat, gamma_gas, _
                       Bob_m3m3, Twh_C, Tbh_C, _
                       roughness_m, _
                       ESP_ID, ESP_numStages, esp_freq, _
                       PVTcorr, HydrCorr, Ksep_fr)
    well.ESP.PressureDegradation = Kdegr_d
    Call well.Calc_Plin_Pwf_atma(SetPT(Pwf_atma, Tbh_C))     ' проведем расчет
    ' в качестве результата выведем ряд расчитанных значений давления
    With well
        Well_Plin_Pwf_atma = Array(Array(.Pline_atma, .Pbuf_atma, .Pdischarge_atma, .Pintake_atma, .Pwf_atma, "Давления атм, линейное, буферное, на приеме насоса, на выкиде насоса, забойное"), _
                                  Array(.Tsurf_C, .Twh_C, .Tdischarge_C, .Tintake_c, .Tbh_C, "Температура С, на поверхности, буферное, на приеме насоса, на выкиде насоса, забойное"))
    ' можно еще добавить сюда вывод кривых распределения давления и температуры по стволу и еще 4 параметров  (потом)
    End With
End Function
Public Function Well_calcKdegr_fr(Pwf_atma, Pbuf_atma, Q_m3Day, _
                      Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional Dcas_mm = 127, Optional dtub_mm = 62, Optional dchoke_mm = -1, _
                      Optional WCT_perc = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                      Optional gamma_oil = const_gamma_oil_default, Optional gamma_wat = const_gamma_wat_default, Optional gamma_gas = const_gamma_gas_default, _
                      Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
                      Optional roughness_m As Double = 0.0001, _
                      Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional esp_freq = 50, _
                      Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0, Optional Ksep_fr As Double = 0)
' функция расчета линейного давления скважины по забойному
    Dim well As CWell
    Set well = InitWellData(Q_m3Day, _
                       Hperf_m, Hpump_m, Udl_m, Dcas_mm, dtub_mm, dchoke_mm, _
                       WCT_perc, Rp_m3m3, rsb_m3m3, Pb_atma, Tres_C, _
                       gamma_oil, gamma_wat, gamma_gas, _
                       Bob_m3m3, Twh_C, Tbh_C, _
                       roughness_m, _
                       ESP_ID, ESP_numStages, esp_freq, _
                       PVTcorr, HydrCorr, Ksep_fr)
'    Set well.Pbuf_atma = Pbuf_atma
    Call well.Calc_Well(Pbuf_atma, Pbuf_atma, Pwf_atma, Tbh_C, CalcChoke:=False)
'    Call well.fin(SetPT(Pwf_atma, Tbh_C))     ' проведем расчет
'    Call well.Calc_Plin_Pwf_atma(SetPT(Pwf_atma, Tbh_C))     ' проведем расчет
    ' в качестве результата выведем рад расчитанных значений давления
    With well
        Well_calcKdegr_fr = Array(Array(.ESPPressureDegradation, .Pline_atma, .Pbuf_atma, .Pdischarge_atma, .Pintake_atma, .Pwf_atma, "деградация ЭЦН ,Давления атм, линейное, буферное, на приеме насоса, на выкиде насоса, забойное"), _
                                  Array(.Kseptotal_d, .Tsurf_C, .Twh_C, .Tdischarge_C, .Tintake_c, .Tbh_C, "Ксеп,Температура С, на поверхности, буферное, на приеме насоса, на выкиде насоса, забойное"))
    ' можно еще добавить сюда вывод кривых распределения давления и температуры по стволу и еще 4 параметров  (потом)
    End With
End Function
Public Function Well_Pwf_Plin_atma(Plin_atma, Q_m3Day, _
                      Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional Dcas_mm = 127, Optional dtub_mm = 62, Optional dchoke_mm = -1, _
                      Optional WCT_perc = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                      Optional gamma_oil = const_gamma_oil_default, Optional gamma_wat = const_gamma_wat_default, Optional gamma_gas = const_gamma_gas_default, _
                      Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
                      Optional roughness_m As Double = 0.0001, _
                      Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional esp_freq = 50, _
                      Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0, Optional Ksep_fr As Double = 0, _
                      Optional Kdegr_d As Double = 0)
' функция расчета забойному давления скважины по линейного
    Dim well As CWell
    Set well = InitWellData(Q_m3Day, _
                       Hperf_m, Hpump_m, Udl_m, Dcas_mm, dtub_mm, dchoke_mm, _
                       WCT_perc, Rp_m3m3, rsb_m3m3, Pb_atma, Tres_C, _
                       gamma_oil, gamma_wat, gamma_gas, _
                       Bob_m3m3, Twh_C, Tbh_C, _
                       roughness_m, _
                       ESP_ID, ESP_numStages, esp_freq, _
                       PVTcorr, HydrCorr, Ksep_fr)
    well.ESP.PressureDegradation = Kdegr_d
    Call well.Calc_Pwf_Plin_atma(Plin_atma, Tbh_C, fast:=False)         ' проведем расчет
    ' в качестве результата выведем рад расчитанных значений давления
    With well
        Well_Pwf_Plin_atma = Array(Array(.Pwf_atma, .Pintake_atma, .Pdischarge_atma, .Pbuf_atma, .Pline_atma, "Давления атм,забойное, на выкиде насоса, на приеме насоса, буферное, линейное "), _
                                  Array(.Tbh_C, .Tintake_c, .Tdischarge_C, .Twh_C, .Tsurf_C, "Температура С,  забойное,на выкиде насоса, на приеме насоса, буферное, на поверхности "))
    ' можно еще добавить сюда вывод кривых распределения давления и температуры по стволу и еще 4 параметров  (потом)
    End With
End Function
'Public Function Well_Pwf_Hdyn_atma(PI_m3dayatm, Plin_atma, Optional Pres_atma = 250, _
'                                  Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional dcas_mm = 127, Optional dtub_mm = 62, _
'                                  Optional WCT_perc = 0, Optional Rp_m3m3 As Double = -1, Optional Rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
'                                  Optional gamma_oil = const_gamma_oil_default, Optional gamma_wat = const_gamma_wat_default, Optional gamma_gas = const_gamma_gas_default, _
'                                  Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
'                                  Optional roughness_m As Double = 0.0001, _
'                                  Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional ESP_freq = 50, _
'                                  Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0)
'' функция расчета забойному давления скважины по линейного
'    Dim PS As New CProdSystem
'    PS.Reservoir.InitProp Pres_atma, Pb_atma, WCT_perc
'    PS.Reservoir.PI_m3dayatm = PI_m3dayatm
'    Set PS.well = InitWellData(1, _
'                       Hperf_m, Hpump_m, Udl_m, dcas_mm, dtub_mm, _
'                       WCT_perc, Rp_m3m3, Rsb_m3m3, Pb_atma, Tres_C, _
'                       gamma_oil, gamma_wat, gamma_gas, _
'                       Bob_m3m3, Twh_C, Tbh_C, _
'                       roughness_m, _
'                       ESP_ID, ESP_numStages, ESP_freq, _
'                       PVTcorr, HydrCorr)
'    PS.Calc_Nodal_PI Plin_atma
'    Call well.Calc_Plin_Pwf_atma(SetPT(PS.Pwf_atma, Tbh_C))     ' проведем расчет
'    With well
'        Well_Pwf_Plin_atma = Array(Array(.Pwf_atma, .Pintake_atma, .Pdischarge_atma, .Pbuf_atma, .Pline_atma, "Давления атм,забойное, на выкиде насоса, на приеме насоса, буферное, линейное "), _
'                                  Array(.Tbh_C, .Tintake_C, .Tdischarge_C, .Twh_C, .Tsurf_C, "Температура С,  забойное,на выкиде насоса, на приеме насоса, буферное, на поверхности "))
'    ' можно еще добавить сюда вывод кривых распределения давления и температуры по стволу и еще 4 параметров  (потом)
'    End With
'
'End Function
Public Function Nodal_Qliq_scm3day(PI_m3dayatm, Plin_atma, Optional Pres_atma = 250, _
                                  Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional Dcas_mm = 127, Optional dtub_mm = 62, Optional dchoke_mm = -1, _
                                  Optional WCT_perc = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                                  Optional gamma_oil = const_gamma_oil_default, Optional gamma_wat = const_gamma_wat_default, Optional gamma_gas = const_gamma_gas_default, _
                                  Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
                                  Optional roughness_m As Double = 0.0001, _
                                  Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional esp_freq = 50, _
                                  Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0, Optional Ksep_fr As Double = 0, _
                                  Optional Kdegr_d As Double = 0)
' расчет узлового анализа по скважине
    Dim PS As New CProdSystem
    PS.Reservoir.InitProp Pres_atma, Pb_atma, WCT_perc
    PS.Reservoir.PI_m3dayatm = PI_m3dayatm
    Set PS.well = InitWellData(1, _
                       Hperf_m, Hpump_m, Udl_m, Dcas_mm, dtub_mm, dchoke_mm, _
                       WCT_perc, Rp_m3m3, rsb_m3m3, Pb_atma, Tres_C, _
                       gamma_oil, gamma_wat, gamma_gas, _
                       Bob_m3m3, Twh_C, Tbh_C, _
                       roughness_m, _
                       ESP_ID, ESP_numStages, esp_freq, _
                       PVTcorr, HydrCorr, Ksep_fr)
    PS.well.ESP.PressureDegradation = Kdegr_d
    Set PS.Fluid = PS.well.Fluid
    PS.Calc_Nodal_PI Plin_atma
    Call PS.well.Calc_Plin_Pwf_atma(SetPT(PS.Pwf_atma, Tbh_C))     ' проведем расчет
    With PS.well
        Nodal_Qliq_scm3day = Array(Array(PS.Qliq_scm3day, .Pwf_atma, .Pintake_atma, .Pdischarge_atma, .Pbuf_atma, .Pline_atma, "Дебит, Давления атм,забойное, на выкиде насоса, на приеме насоса, буферное, линейное "), _
                                  Array(PS.Fluid.wc_perc, .Tbh_C, .Tintake_c, .Tdischarge_C, .Twh_C, .Tsurf_C, "Обводненность, Температура С,  забойное,на выкиде насоса, на приеме насоса, буферное, на поверхности "))
    ' можно еще добавить сюда вывод кривых распределения давления и температуры по стволу и еще 4 параметров  (потом)
    End With
End Function
' ==============  функции для расчета пласта ==========================
' =====================================================================
' расчет дебита по давлению и продуктивности
Public Function IPR_Ql_sm3Day(PI_m3dayatm, Pr_atma, Pwf_atma, _
        Optional WCT_perc As Double = 0, Optional Pb_atma As Double = -1)
'
' PI_m3dayatm   - коэффициент продуктивности
' Pr_atma        - пластовое давление, атм
' Pwf_atma       - забойное давление
'
' необязательные параметры
' WCT_perc      - обводненность
' Pb_atma        - давление насыщения
'
    Dim res As New CReservoir
    If Pb_atma <= 0 Then Pb_atma = 0   ' поставим ноль иначе флюид додсчитает по корреляции значение
    res.InitProp Pr_atma, Pb_atma, WCT_perc
    res.PI_m3dayatm = PI_m3dayatm
    
    IPR_Ql_sm3Day = res.Calc_Q_m3Day(Pwf_atma)
    Set res = Nothing
End Function
' расчет дебита по давлению и продуктивности
Public Function IPR_Pwf_atma(PI_m3dayatm, Pr_atma, Ql_m3day, _
        Optional WCT_perc As Double = 0, Optional Pb_atma As Double = -1)
'
' PI_m3dayatm   - коэффициент продуктивности
' Pr_atma        - пластовое давление, атм
' Ql_m3day      - дебит жидкости скважины на поверхности
'
' необязательные параметры
' WCT_perc      - обводненность
' Pb_atma        - давление насыщения
'
    Dim res As New CReservoir
    If Pb_atma <= 0 Then Pb_atma = 0   ' поставим ноль иначе флюид додсчитает по корреляции значение
    res.InitProp Pr_atma, Pb_atma, WCT_perc
    res.PI_m3dayatm = PI_m3dayatm
    
    IPR_Pwf_atma = res.Calc_Pwf_atma(Ql_m3day)
    Set res = Nothing
End Function
' расчет продуктивности
Public Function IPR_PI_sm3dayatm(Qtest_m3day, Pwftest_atma, Pr_atma, _
                Optional WCT_perc As Double = 0, Optional Pb_atma As Double = -1)
'
' Qtest_m3day   - тестовый дебит скважины
' Pwftest_atma   - тестовое забойное давление
' Pr_atma        - пластовое давление, атм
'
' необязательные параметры
' WCT_perc      - обводненность
' Pb_atma        - давление насыщения
'
    Dim res As New CReservoir
    If Pb_atma <= 0 Then Pb_atma = 0   ' поставим ноль иначе флюид додсчитает по корреляции значение
    res.InitProp Pr_atma, Pb_atma, WCT_perc
    On Error Resume Next
    IPR_PI_sm3dayatm = res.Calc_PI_m3DayAtm(Qtest_m3day, Pwftest_atma)
    Set res = Nothing
End Function
' =============== функции для расчета УЭЦН  ============================
'
'
Public Function ESP_head_m(Qliq_m3day As Double, Optional NumStages As Integer = 1, _
                            Optional Freq As Double = 50, Optional PumpID = 674, _
                            Optional mu_cSt As Double = -1) As Double
' напор УЭЦН номинальный
' Qliq_m3day - дебит жидкости в условиях насоса (стенд)
' NumStages  - количество ступеней
' Freq       - частота вращения насоса
' PumpID     - номер насоса в базе данных
' mu_cSt     - вязкость жидкости
'
    If Not checkID(PumpID) Then
        ESP_head_m = 0
        Exit Function
    End If
    
    ESP.Frequency = Freq
    ESP.StageNum = NumStages
    ESP_head_m = ESP.Get_ESP_Head_m(Qliq_m3day, NumStages, mu_cSt)
End Function
Public Function ESP_Power_W(Qliq_m3day As Double, Optional NumStages As Integer = 1, _
                            Optional Freq As Double = 50, Optional PumpID = 674, _
                            Optional mu_cSt As Double = -1) As Double
' мощность УЭЦН номинальная потребляемая
' Qliq_m3day - дебит жидкости в условиях насоса (стенд)
' NumStages  - количество ступеней
' Freq       - частота вращения насоса
' PumpID     - номер насоса в базе данных
' mu_cSt     - вязкость жидкости
    
    If Not checkID(PumpID) Then
        ESP_Power_W = 0
        Exit Function
    End If
    
    ESP.Frequency = Freq
    ESP.StageNum = NumStages
    ESP_Power_W = ESP.Get_ESP_Power_W(Qliq_m3day, NumStages, mu_cSt)
End Function
Public Function ESP_eff_fr(Qliq_m3day As Double, Optional NumStages As Integer = 1, _
                            Optional Freq As Double = 50, Optional PumpID = 674, _
                            Optional mu_cSt As Double = -1) As Double
' КПД УЭЦН номинальный
' Qliq_m3day - дебит жидкости в условиях насоса (стенд)
' NumStages  - количество ступеней
' Freq       - частота вращения насоса
' PumpID     - номер насоса в базе данных
' mu_cSt     - вязкость жидкости
    
    If Not checkID(PumpID) Then
        ESP_eff_fr = 0
        Exit Function
    End If
    
    ESP.Frequency = Freq
    ESP.StageNum = NumStages
    ESP_eff_fr = ESP.Get_ESP_effeciency_fr(Qliq_m3day, mu_cSt)
End Function
Public Function ESP_name(Optional PumpID = 674) As String
' PumpID - идентификатор насоса в базе данных
    If Not checkID(PumpID) Then
        ESP_name = ""
        Exit Function
    End If
    ESP_name = ESP.PumpName
End Function
Public Function ESP_maxRate_m3day(Optional Freq As Double = 50, Optional PumpID = 674) As Double
    If Not checkID(PumpID) Then
        ESP_maxRate_m3day = 0
        Exit Function
    End If
    ESP.Frequency = Freq
    ESP_maxRate_m3day = ESP.MaxRate_m3day
End Function
Public Function ESP_optRate_m3day(Optional Freq As Double = 50, Optional PumpID = 674) As Double
    If Not checkID(PumpID) Then
        ESP_optRate_m3day = 0
        Exit Function
    End If
    ESP.Frequency = Freq
    ESP_optRate_m3day = ESP.NominalRate_m3day
End Function
Public Function ESP_IDbyRate(Q As Double)
' возвращает ID в зависимости от диапазона дебитов
' насосы подобраны вручную из текущей базы
' функция нужна для удобства использования непосредственно в Excel для тестовых заданий и учебных примеров
    If Q > 0 And Q < 20 Then ESP_IDbyRate = 738: Exit Function   ' ВНН5-15
    If Q >= 20 And Q < 40 Then ESP_IDbyRate = 740: Exit Function   ' ВНН5-30
    If Q >= 40 And Q < 60 Then ESP_IDbyRate = 1005: Exit Function    ' ВНН5-50
    If Q >= 60 And Q < 100 Then ESP_IDbyRate = 1006: Exit Function    ' ВНН5-80
    If Q >= 100 And Q < 150 Then ESP_IDbyRate = 737: Exit Function    ' ВНН5-125
    If Q >= 150 And Q < 250 Then ESP_IDbyRate = 1010: Exit Function    ' ЭЦН5A-200
    If Q >= 250 And Q < 350 Then ESP_IDbyRate = 1033: Exit Function    ' ЭЦН5A-320Э
    If Q >= 350 And Q < 600 Then ESP_IDbyRate = 753: Exit Function    ' ВНН5А-500
    If Q >= 600 And Q < 800 Then ESP_IDbyRate = 754: Exit Function    ' ВНН5А-700
    If Q >= 800 And Q < 1200 Then ESP_IDbyRate = 755: Exit Function  ' ВНН6-1000
    If Q > 1200 Then ESP_IDbyRate = 264
    
End Function
Public Function ESP_dP_atma(Pin_atma As Double, Qliq_m3day As Double, WCT_perc As Double, _
                        Optional NumStages As Integer = 1, Optional Freq As Double = 50, _
                        Optional PumpID = 674, _
                        Optional gamma_gas = const_gamma_gas_default, _
                        Optional gamma_oil = const_gamma_oil_default, _
                        Optional gamma_wat = const_gamma_wat_default, _
                        Optional rsb_m3m3 = const_Rsb_default, _
                        Optional Rp_m3m3 As Double = -1, _
                        Optional Pb_atma As Double = -1, _
                        Optional Tres_C As Double = const_Tres_default, _
                        Optional Bob_m3m3 As Double = -1, _
                        Optional Muob_cP As Double = -1, _
                        Optional PVTcorr = StandingBased, _
                        Optional Ksep_fr As Double = 0, _
                        Optional PKsep_atma As Double = -1, _
                        Optional TKsep_C As Double = -1, _
                      Optional Tin_C As Double = 50, _
                      Optional CalcFromIntake As Integer = 1, _
                      Optional GasDegtType As Integer = 0, Optional Kdegr As Double = 0)
'  расчет перепада давления в насосе при перекачке ГЖС с заданными
' характеристиками (харктеристики фдюида для поверхности берутся)
' Pin_atma       - давление на приеме насоса
' Qliq_m3day    - дебит жидкости на поверхности
' WCT_perc      - обводненность
' NumStages     - количество ступеней
' Freq          - частота, Гц
' PumpID        - идентификатор насоса
' PVT           - набор данных PVT
' Tin_C         - температура на приеме насоа
' CalcFromIntake - режим расчета
' GasDegtType   - тип насоса по работе с газом
' Kdegr         - коэффициент деградации напора
    Dim PT As PTtype
    If Not checkID(PumpID) Then
        ESP_dP_atma = 0
        Exit Function
    End If
    Dim Fluid As New CPVT
    Call Fluid.SetRpRsb(Rp_m3m3, CDbl(rsb_m3m3))
    Fluid.Pb_atma = Pb_atma
    Fluid.Tres_C = Tres_C
    Fluid.PVT_CORRELATION = PVTcorr
    Fluid.Bob_m3m3 = Bob_m3m3
    Fluid.gamma_g = gamma_gas
    Fluid.gamma_o = gamma_oil
    Fluid.gamma_w = gamma_wat
    Fluid.Qliq_scm3day = Qliq_m3day
    Fluid.wc_perc = WCT_perc
    Fluid.Muob_cP = Muob_cP
    
'   Dim fluidESP As CPVT
'   Ksep_fr = 0.5
    If PKsep_atma < 0 Then PKsep_atma = Pin_atma
    If TKsep_C < 0 Then TKsep_C = Tin_C
    If Ksep_fr > 0 And Ksep_fr <= 1 Then
        Call Fluid.ModifyFluidTubPVTafterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasnotGoesIntoSolution)
    End If
    Set ESP.Fluid = Fluid 'ESP
    
    ESP.ESPtype = GasDegtType
    ESP.Frequency = Freq
    ESP.StageNum = NumStages
    ESP.PressureDegradation = Kdegr
  '  ESP_dP_atma = ESP.Calc_ESP_dP_atma(Pin_atma, Ksep_fr, Tin_C, CalcFromIntake)
    PT.P_atma = Pin_atma
    PT.T_C = Tin_C
    Call ESP.Calc_ESP_DownUp(PT)
    ESP_dP_atma = Array(ESP.Pdis_atma - Pin_atma, ESP.Tdischarge_C - Tin_C)
End Function
Public Function ESP_dPdown_atma(Pin_atma As Double, Qliq_m3day As Double, Optional Ksep_fr As Double = 0, Optional NumStages As Integer = 1, Optional Freq As Double = 50, Optional PumpID = 674, _
                      Optional WCT_perc As Double = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                      Optional gamma_oil = const_gamma_oil_default, Optional gamma_wat = const_gamma_wat_default, Optional gamma_gas = const_gamma_gas_default, _
                      Optional Bob_m3m3 As Double = -1, Optional Tin_C As Double = 50, Optional Tout_C As Double = 50, _
                      Optional PVTcorr As PVT_CORRELATION = 0, Optional CalcFromIntake As Integer = 1, _
                      Optional GasDegtType As Integer = 0, Optional Kdegr As Double = 0)
'  расчет перепада давления в насосе при перекачке ГЖС с заданнвми характеристиками (харктеристики фдюида для поверхности берутся)
'
    Dim PTup As PTtype
    If Not checkID(PumpID) Then
        ESP_dPdown_atma = 0
        Exit Function
    End If
    Dim Fluid As New CPVT
    Call Fluid.SetRpRsb(Rp_m3m3, rsb_m3m3)
    Fluid.Pb_atma = Pb_atma
    Fluid.Tres_C = Tres_C
    Fluid.PVT_CORRELATION = PVTcorr
    Fluid.Bob_m3m3 = Bob_m3m3
    Fluid.gamma_g = gamma_gas
    Fluid.gamma_o = gamma_oil
    Fluid.gamma_w = gamma_wat
    Fluid.Qliq_scm3day = Qliq_m3day
    Fluid.wc_perc = WCT_perc
    
'   Dim fluidESP As CPVT
'   Ksep_fr = 0.5
    
    Call Fluid.ModifyFluidTubPVTafterSeparation(Pin_atma, Tin_C, Ksep_fr, GasnotGoesIntoSolution)
    Set ESP.Fluid = Fluid 'ESP
    
    ESP.ESPtype = GasDegtType
    ESP.Frequency = Freq
    ESP.StageNum = NumStages
    ESP.PressureDegradation = Kdegr
  '  ESP_dP_atma = ESP.Calc_ESP_dP_atma(Pin_atma, Ksep_fr, Tin_C, CalcFromIntake)
   ' Call
    PTup.P_atma = Pin_atma
    PTup.T_C = Tin_C + 20
    ESP_dPdown_atma = Pin_atma - ESP.Calc_ESP_UpDown(PTup, Tin_C).P_atma  'ESP.Pdis_atma
End Function
'--------------------- Двигатель -----------------------
' функция загрузки параметров двигателя с листа
Public Function LoadMotorManually(Optional P_kW = 30, Optional U_V = 1000, Optional I_A = 10, _
                    Optional Eff = 0.8, Optional Cosphi = 0.8, Optional f_Hz = 50, _
                    Optional s = 0.05, Optional lambda = 2, Optional Diam = 117) As String
    ' возвращаяет код двигателя
On Error GoTo er1:
    With Motor
        .ID = 0
        .MotorName = "_ПЭД_" & P_kW & "-" & Diam & "-" & U_V
        .ManufacturerName = "Ручной ввод"
        .Pnom_kW = P_kW
        .Unom_lin_V = U_V
        .Inom_A = I_A
        .Effnom_d = Eff
        .CosPhinom_d = Cosphi
        .fnom_Hz = f_Hz
        .Snom_d = s
        .Lambda_d = lambda
        .minDcas_mm = Diam + 6
        
        Call .CalcModelGridin
    End With
    LoadMotorManually = Motor.MotorName
    Exit Function
er1:
 addLogMsg "Не удалось загрузить вручную параметры двигателя. Загружены параметры по умолчанию"
 Set Motor = New CESPMotor
End Function
' функция расчета загрузки двигателя от скольжения
' rnt 03/2016
Public Function MotorLoad_d(s As Double, _
                    Optional freqU_Hz As Double = 50, _
                    Optional U_V As Double = -1, _
                    Optional MotorID As Integer = 0) As Double
'
'   s           - скольжение от 0 до 1
' опциональные параметры
'   freqU_Hz    - частота вращения внешнего поля
'   U_V         - напряжение питания двигателя, фазовое, В
' выход
'   число       - значение момента двигателя при заданных частоте и напряжении
    Application.Volatile (True)  ' поскольку пока есть зависимость от внешнего объекта - сделаем функцию чувствительной к пересчету
    
'    Dim Motor As New CESPmotor
'    Motor.CalcModelGridin
    
    If freqU_Hz > 0 Then Motor.f_Hz = freqU_Hz
    If U_V > 0 Then Motor.Ulin_V = U_V
    
    Motor.S_d = s
    MotorLoad_d = Motor.Load_d
    
End Function
' функция расчета момента двигателя от скольжения
' rnt 03/2016
Public Function MotorM_Nm(s As Double, _
                    Optional freqU_Hz As Double = 50, _
                    Optional U_V As Double = -1, _
                    Optional MotorID As Integer = 0) As Double
'
'   s           - скольжение от 0 до 1
' опциональные параметры
'   freqU_Hz    - частота вращения внешнего поля
'   U_V         - напряжение питания двигателя, фазовое, В
' выход
'   число       - значение момента двигателя при заданных частоте и напряжении
    Application.Volatile (True)  ' поскольку пока есть зависимость от внешнего объекта - сделаем функцию чувствительной к пересчету
    
'    Dim Motor As New CESPmotor
'    Motor.CalcModelGridin
    
    If freqU_Hz > 0 Then Motor.f_Hz = freqU_Hz
    If U_V > 0 Then Motor.Ulin_V = U_V
    
    Motor.S_d = s
    MotorM_Nm = Motor.M_Nm
    
End Function
' функция расчета рабочего тока двигателя
' rnt 03/2016
Public Function MotorI_A(s As Double, _
                    Optional freqU_Hz As Double = 50, _
                    Optional U_V As Double = -1, _
                    Optional MotorID As Integer = 0) As Double
'
'   s           - скольжение от 0 до 1
' опциональные параметры
'   freqU_Hz    - частота вращения внешнего поля
'   U_V         - напряжение питания двигателя, фазовое, В
' выход
'   число       - значение момента двигателя при заданных частоте и напряжении
    Application.Volatile (True)  ' поскольку пока есть зависимость от внешнего объекта - сделаем функцию чувствительной к пересчету
 '   Dim Motor As New CESPmotor
    If freqU_Hz > 0 Then Motor.f_Hz = freqU_Hz
    If U_V > 0 Then Motor.Ulin_V = U_V
'    Motor.CalcModelGridin
    
    Motor.S_d = s
    MotorI_A = Motor.I_A
    
End Function
' функция расчета коэффициента мощности двигателя
' rnt 03/2016
Public Function MotorCosPhi_d(s As Double, _
                    Optional freqU_Hz As Double = 50, _
                    Optional U_V As Double = -1, _
                    Optional MotorID As Integer = 0) As Double
'
'   s           - скольжение от 0 до 1
' опциональные параметры
'   freqU_Hz    - частота вращения внешнего поля
'   U_V         - напряжение питания двигателя, фазовое, В
' выход
'   число       - значение момента двигателя при заданных частоте и напряжении
    Application.Volatile (True)  ' поскольку пока есть зависимость от внешнего объекта - сделаем функцию чувствительной к пересчету
'    Dim Motor As New CESPmotor
    If freqU_Hz > 0 Then Motor.f_Hz = freqU_Hz
    If U_V > 0 Then Motor.Ulin_V = U_V
'    Motor.CalcModelGridin
    
    Motor.S_d = s
    MotorCosPhi_d = Motor.CosPhi_d
    
End Function
' функция расчета КПД двигателя
' rnt 03/2016
Public Function MotorEff_d(s As Double, _
                    Optional freqU_Hz As Double = 50, _
                    Optional U_V As Double = -1, _
                    Optional MotorID As Integer = 0) As Double
'
'   s           - скольжение от 0 до 1
' опциональные параметры
'   freqU_Hz    - частота вращения внешнего поля
'   U_V         - напряжение питания двигателя, фазовое, В
' выход
'   число       - значение момента двигателя при заданных частоте и напряжении
    Application.Volatile (True)  ' поскольку пока есть зависимость от внешнего объекта - сделаем функцию чувствительной к пересчету
 '   Dim Motor As New CESPmotor
    If freqU_Hz > 0 Then Motor.f_Hz = freqU_Hz
    If U_V > 0 Then Motor.Ulin_V = U_V
 '   Motor.CalcModelGridin
    
    Motor.S_d = s
    MotorEff_d = Motor.Eff_d
    
End Function
' функция расчета скольжения при заданном моменте
' rnt 03/2016
Public Function MotorS_d(M_Nm As Double, _
                    Optional freqU_Hz As Double = 50, _
                    Optional U_V As Double = -1, _
                    Optional MotorID As Integer = 0) As Double
'
'   s           - скольжение от 0 до 1
' опциональные параметры
'   freqU_Hz    - частота вращения внешнего поля
'   U_V         - напряжение питания двигателя, фазовое, В
' выход
'   число       - значение момента двигателя при заданных частоте и напряжении
   ' Dim Motor As New CESPmotor
    Motor.CalcModelGridin
    
    If freqU_Hz > 0 Then Motor.f_Hz = freqU_Hz
    If U_V > 0 Then Motor.Ulin_V = U_V
    
 '   motor.M_Nm = M_Nm
    Call Motor.calc_s_d(M_Nm)
    MotorS_d = Motor.S_d
    
End Function
' ==============================================================
' Расчет скважины
' ==============================================================
'Public Function Well_Power_w1(ByVal Hmes_m As Double, ByVal Hpump_m As Double, _
'                             ByVal Pbuf_atma As Double, ByVal Plin_atma As Double, ByVal Pwf_atma As Double, _
'                             ByVal ESP_Qnom_m3day As Double, ByVal ESP_head_m As Double, _
'                             ByVal PI_m3dayatm As Double, _
'                             Optional ByVal PowerMes_W As Double = 0, Optional Pr_atma As Double = 250, _
'                             Optional ByVal Udl_m As Double = 0, _
'                             Optional dtub_mm As Double = 62, Optional dcas_mm As Double = 125, Optional dintake_mm As Double = 102, _
'                             Optional Ksep_d As Double = 0.7, _
'                             Optional WCT_perc As Double = 0, Optional Rp_m3m3 As Double = -1, Optional Rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
'                             Optional gamma_oil = const_gamma_oil_default, Optional gamma_wat = const_gamma_wat_default, Optional gamma_gas = const_gamma_gas_default, _
'                             Optional Bob_m3m3 As Double = -1, _
'                             Optional esp_freq As Double = 50, Optional ESP_U_V As Double = 1000, _
'                             Optional ESP_Motor_Power_nom As Double = 0)
' End Function
' Функция расчета потребляемой мощности с учетом скважинного оборудования  (для проведения факторного анализа и прогноза УРЭ)
'
Public Function Well_Power_w(ByVal Hmes_m As Double, ByVal Hpump_m As Double, _
                             ByVal Pbuf_atma As Double, ByVal Plin_atma As Double, ByVal Pwf_atma As Double, _
                             ByVal ESP_Qnom_m3day As Double, ByVal ESP_head_m As Double, _
                             ByVal PI_m3dayatm As Double, _
                             Optional Pr_atma As Double = 250, _
                             Optional ByVal Udl_m As Double = 0, _
                             Optional dtub_mm As Double = 62, Optional Dcas_mm As Double = 125, Optional dintake_mm As Double = 102, _
                             Optional Ksep_d As Double = 0.7, _
                             Optional WCT_perc As Double = 0, Optional Rp_m3m3 As Double = -1, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                             Optional gamma_oil = const_gamma_oil_default, _
                             Optional Bob_m3m3 As Double = -1, _
                             Optional esp_freq As Double = 50, Optional ESP_U_V As Double = 1000, _
                             Optional ESP_Power_W As Double = 0, Optional ESP_cos_phi As Double = 0.95, _
                             Optional ESP_cable_R_Om As Double = 1.8, Optional ESP_power_degr As Double = 0)
' Входные параметры
' Hmes_m - измерененная глубина кровли пласта, м (точка для которой будет проводиться расчет забойного давления)
' Hpump_m - измеренная глубина установки насоса, м
' Pbuf_atma - буферное давление, атм
' Plin_atma - линейное давление, атм
' Pwf_atma  - забойное давление, атм
' ESP_Qnom_m3day
' ESP_head_m
' PI_m3dayatm
' PowerMes_W   - потребляемая мощность УЭЦН по замеру, Вт, по умолчанию не учитывается
' Pr_atma
' Udl_m  - удлинение, м,  отклонение вертикальной глубины от изменеренной  (по умолчанию равно 0)
' dtub_mm       - диаметр НКТ, внутренний
' dcas_mm       - диаметр эксплуатационной колонны в месте уставноки НКТ
' dintake_mm    - диаметр приемной сетки
' Ksep_d        - коэффициент сепарации
' WCT_perc
' Rp_m3m3
' Rsb_m3m3
' Pb_atma
' Tres_C
' gamma_oil
' gamma_wat
' gamma_gas
' Bob_m3m3
' PVTcorr
'
'
'
'
'
    
Dim gamma_wat As Double
gamma_wat = const_gamma_wat_default
Dim gamma_gas As Double
gamma_gas = const_gamma_gas_default
    Dim PVTcorr As PVT_CORRELATION
    PVTcorr = 0
    Dim rsb_m3m3 As Double
    rsb_m3m3 = Rp_m3m3
    Dim angle_deg As Double
    Dim Qliq_scm3day As Double   ' дебит скважины на поверхности
    Dim Qmix_intake_m3day As Double, Qmix_dis_m3day   ' дебит ГЖС на приеме насоса после сепарации
    Dim Qmix_av_m3day As Double
    Dim PTintake, PTdischarge
    Dim Pintake_atma As Double, Pdischarge_atma As Double
    Dim Tintake_c As Double, Tdischarge_C As Double
    Dim GeoGradT_Cm As Double ' геотермальный градиент температуры
    Dim dPpump_fact_atma As Double    ' перепад давления развиваемый ЭЦН по факту
    Dim dPpump_teor_atma As Double    ' перепад давления ЭЦН по характеристике
    
    Dim PumpID
    Dim pump_eff As Double
    Dim Power_liq_W As Double
    Dim Power_pump_w As Double
    Dim dPower_protector_w As Double
    Dim dPower_gassep_w As Double
    Dim Power_shaft_w As Double
    Dim motor_eff As Double
    Dim Power_motor_w As Double
    
    Dim power_cable_w As Double
    Dim dpower_cable_w As Double
    Dim dpower_trans_w As Double
    Dim dpower_CS_w As Double
    
    Dim power_well_w As Double
    
    Dim Imotor_A As Double
    Dim dUcable_V As Double
    
    Dim degr As Double
    ' расчет потребления энергии
    GeoGradT_Cm = 0.03
    
    ' считаем какой угол наклона скважины
    angle_deg = 90 - ArcCos((Hmes_m - Udl_m) / Hmes_m) / const_Pi * 180
    
    ' 1. Расчитываем дебит жидкости по продуктивности
    Qliq_scm3day = IPR_Ql_sm3Day(PI_m3dayatm, Pr_atma, Pwf_atma, WCT_perc, Pb_atma)
    
    ' 2. ищем давление на приеме насоса
    Tintake_c = Tres_C - GeoGradT_Cm * (Hmes_m - Hpump_m)
    PTintake = MF_dPpipe_atma(Hmes_m - Hpump_m, Pwf_atma, Qliq_scm3day, WCT_perc, Tres_C, Tintake_c, angle_deg, Dcas_mm, , gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, _
                  Bob_m3m3, , PVTcorr:=PVTcorr)
    Pintake_atma = PTintake(0)
    Tintake_c = PTintake(1)
    ' 3. ищем или учитываем коэффициент сепарации
    
    ' 4. ищем давление на выкиде с учетом сепарации
    Tdischarge_C = Tintake_c
    PTdischarge = MF_dPpipe_atma(Hpump_m, Pbuf_atma, Qliq_scm3day, WCT_perc, Tdischarge_C, , angle_deg, dtub_mm, , gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, _
                  Bob_m3m3, , PVTcorr:=PVTcorr)
    Pdischarge_atma = PTdischarge(0)
    Tdischarge_C = PTdischarge(1)
    
    ' 5. ищем фактический перепад давления в насосе
    dPpump_fact_atma = Pdischarge_atma - Pintake_atma
    
    ' 6. ищем средний расход ГЖС через насос
    Qmix_intake_m3day = PVT_Qmix_m3day(Qliq_scm3day, WCT_perc, Pintake_atma, Tintake_c, gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, , PVTcorr, _
                        Ksep_d, Pintake_atma, Tintake_c)
    Qmix_dis_m3day = PVT_Qmix_m3day(Qliq_scm3day, WCT_perc, Pdischarge_atma, Tdischarge_C, gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, , PVTcorr, _
                        Ksep_d, Pintake_atma, Tintake_c)
    Qmix_av_m3day = (Qmix_intake_m3day + Qmix_dis_m3day) / 2
     
    ' 7. определяем насос
    PumpID = ESP_IDbyRate(ESP_Qnom_m3day)
    
    ' 8. определяем КПД насоса по характеристике для заданного среднего дебита
    pump_eff = ESP_eff_fr(Qmix_av_m3day, 1, esp_freq, PumpID)
    
    ' 9. ищем полезную мощность по факту для насоса
    Power_liq_W = Qmix_av_m3day * dPpump_fact_atma * const_convert_atma_Pa / const_conver_day_sec
    
    ' 10. ищем мощность потребляемую насосом с вала
    Power_pump_w = Power_liq_W / pump_eff
    
    ' 11 оценим мощности потребляемые гидрозащитой и газосепаратором и найдем мощность на валу
    dPower_protector_w = 400
    dPower_gassep_w = 500
    
    Power_shaft_w = Power_pump_w + dPower_protector_w + dPower_gassep_w
    
    ' 12 оценим мощность потребляемую двигателем
    
    motor_eff = 0.9   ' пока так - потом сделать надо расчет по характеристике
    
    Power_motor_w = Power_shaft_w / motor_eff
    
    ' 13 оценим потери в кабеле - для этого найдем примерно ток двигателя
    
    Imotor_A = Power_motor_w / 1.732050808 / ESP_U_V / ESP_cos_phi
    
    ' 14 по данным тока и сопротивления кабеля найдем падение напряжения в кабеле
    dUcable_V = Imotor_A * ESP_cable_R_Om
    
    ' 15 по падению напряжения оценим мощность рассеиваемую кабелем в тепло. учитываем 3 жилы. Тут учитывается полный ток и активный и реактивный
    
    dpower_cable_w = 3 * dUcable_V * Imotor_A
    power_cable_w = Power_motor_w + dpower_cable_w
    
    dpower_trans_w = 0.03 * power_cable_w
    dpower_CS_w = 0.03 * power_cable_w
    power_well_w = power_cable_w + dpower_trans_w + dpower_CS_w
    power_well_w = power_well_w / (1 - ESP_power_degr)
    
    degr = 1 - power_well_w / ESP_Power_W
    
    Well_Power_w = Array(power_well_w, degr)
     
End Function
'Функция для вычисления соответствующего диаметра порта клапана через заданный расход газа и давления в затрубе и в НКТ на глубине клапан
'Для вычисления используется уравнение Thornhill-Crave
'Возвращает диаметр порта клапана в мм
Public Function GL_dchoke_mm(Qg_m3d As Double, Pu_atma As Double, Pd_atma As Double, gamma_g As Double, Tu_C As Double)
    If Qg_m3d <= 0 Then
        GL_dchoke_mm = 0
        Exit Function
    End If
    
    If Pu_atma < Pd_atma Then
        GL_dchoke_mm = -1
        Exit Function
    End If
    Dim K As Double
    K = 1.31   ' = Cp/Cv (approx 1.31 for natural gases(R Brown) or 1.25 (Mischenko) )
    
    Dim Pu_psi As Double
    Dim Pd_psi As Double
    Pu_psi = Pu_atma * 14.2233 'upstream pressure, psi
    Pd_psi = Pd_atma * 14.2233 'downstream pressure, psi
    
    Dim Tu_F As Double
    Tu_F = Tu_C / 100 * 180 + 32
    
    Dim CD As Double  ' discharge coefficient
    CD = 0.865
    
    Dim g As Double
    g = 32.17 'ft/sec^2
    
    Dim Qg_Mcfd As Double
    Qg_Mcfd = Qg_m3d / 28.31993658
    
    Dim Pd_Pu_crit As Double
    Pd_Pu_crit = (2 / (K + 1)) ^ (K / (K - 1))
    
    Dim Pd_Pu As Double
    Pd_Pu = Pd_atma / Pu_atma
    
    Dim c0 As Double, c1 As Double, c2 As Double
    c0 = ((Pd_Pu ^ (2 / K) - Pd_Pu ^ (1 + 1 / K))) ^ 0.5
    c1 = (Pd_Pu_crit ^ (2 / K) - Pd_Pu_crit ^ (1 + 1 / K)) ^ 0.5
    c2 = (2 * g * K / (K - 1)) ^ 0.5
    
    Dim A As Double
    
    If Pd_Pu <= Pd_Pu_crit Then
        A = Qg_Mcfd / (155.5 * CD * Pu_psi * c1 * c2 / (gamma_g * (Tu_F + 460)) ^ 0.5)
    Else
        A = Qg_Mcfd / (155.5 * CD * Pu_psi * c0 * c2 / (gamma_g * (Tu_F + 460)) ^ 0.5)
    End If
    
    Dim d_in As Double
    d_in = (A * 4 / Application.PI) ^ 0.5
    
    GL_dchoke_mm = d_in / 0.03937
End Function
Function GL_dPgasPipe_atmg(ByVal H_m As Double, ByVal P_atmg As Double, ByVal T_C As Double, _
                               Optional ByVal Dcas_mm As Double = 125, _
                               Optional ByVal dtub_mm As Double = 73, _
                               Optional ByVal gamma_gas As Double = 0.8, _
                               Optional ByVal Qg_scm3day As Double = 10000, _
                               Optional ByVal roughness As Double = 0.001, _
                               Optional ByVal theta As Double = 90 _
                               ) As Double
  
'de - external diameter, m
'di - interior diameter, m
'gamma_gas - relative density of gas
'qg_sc - gas flow, m3/d
'eps - pipe roughness, m
'theta - ,degree
'length - pipe length, m
'T - temperature, C
'P - pressure, atma
Dim de, di, qg_sc, eps, length, t, P
de = Dcas_mm / 1000
di = dtub_mm / 1000
qg_sc = Qg_scm3day
eps = roughness
length = H_m
t = T_C
P = P_atmg
    
    'convert m3/d to scf/d
    qg_sc = qg_sc * 3.28 ^ 3
    
    Dim P_MPa As Double, P_psi As Double
    P_MPa = P * 0.1013 'convert atma to Mpa
    P_psi = P * 14.696 ' convert atma to psi
    
    
    Dim T_K As Double, T_F As Double
    T_K = t + 273 'convert Celcsius to Kelvin
    T_F = (9 / 5) * t + 32 'convert Celcsius to Fahrengheit
     
    Dim T_pc As Double
    Dim p_pc As Double
    Dim z As Double
    
'        T_pc = PseudoTemperatureStanding(gamma_gas)
'        p_pc = PseudoPressureStanding(gamma_gas)
'        Z = ZFactorDranchuk(T_K / T_pc, P_MPa / p_pc)
    z = unf_Calc_Zgas_d(T_K, P_MPa, gamma_gas)
    
    eps = eps * 39.3701 'convert m to in
    
    Dim de_in As Double, di_in As Double
    di_in = di * 39.3701 'convert m to in
    de_in = de * 39.3701 'convert m to in
    Dim dh As Double, da As Double, deq As Double
    dh = de_in - di_in
    da = (de_in ^ 2 - di_in ^ 2) ^ 0.5
    If di_in = 0 Then
        deq = de_in
    Else
        deq = (de_in ^ 2 + di_in ^ 2 - (de_in ^ 2 - di_in ^ 2) / Log(de_in / di_in)) / (de_in - di_in)
    End If
    Dim mu_g As Double
    mu_g = unf_calc_Mug_cP(T_K, P_MPa, z, gamma_gas)
    Dim Re As Double
    Re = 0.020107 * gamma_gas * Abs(qg_sc) * deq / mu_g / da ^ 2
    Dim A As Double, b As Double
    A = (2.457 * Log(1 / ((7 / Re) ^ 0.9 + 0.27 * eps / deq))) ^ 16
    b = (37530 / Re) ^ 16
    Dim f_moody As Double
    f_moody = 8 * ((8 / Re) ^ 12 + 1 / ((A + b) ^ 1.5)) ^ (1 / 12)
    
    Dim gradP As Double
    
    gradP = -0.018786 * gamma_gas * (P_psi + 14.7) * Sin(theta * Application.PI / 180) / (T_F + 460) / z + (1.2595 * 10 ^ (-11)) * f_moody * (T_F + 460) * z * gamma_gas * (qg_sc ^ 2) / (P_psi + 14.7) / dh / da ^ 4
    gradP = gradP * 0.068 / 0.3048 'convert psi/ft to atma/m
    
    GL_dPgasPipe_atmg = P + gradP * length
    
    
End Function
' function to calculated gas passage trough orifice or gas valve
' link in K Brawn AL 2A - Craft, Holden, Graves (p.111)
' also found in Mischenko book
Public Function GL_Qgasvalve_m3day(d_mm As Double, Pu_atma As Double, Pd_atma As Double, gamma_g As Double, Tu_C As Double)
    
    Dim K As Double
    K = 1.31   ' = Cp/Cv (approx 1.31 for natural gases(R Brown) or 1.25 (Mischenko) )
    
    Dim d_in As Double
    d_in = d_mm * 0.03937
    
    Dim Pu_psi As Double
    Dim Pd_psi As Double
    Pu_psi = Pu_atma * 14.2233 'upstream pressure, psi
    Pd_psi = Pd_atma * 14.2233 'downstream pressure, psi
    
    Dim Tu_F As Double
    Tu_F = Tu_C / 100 * 180 + 32
    
    Dim Pd_Pu_crit As Double
    Pd_Pu_crit = (2 / (K + 1)) ^ (K / (K - 1))
    
    
    Dim CD As Double  ' discharge coefficient
    CD = 0.865
    
    Dim g As Double
    g = 32.17 'ft/sec^2
    
    Dim c0 As Double, c1 As Double, c2 As Double
    c1 = (Pd_Pu_crit ^ (2 / K) - Pd_Pu_crit ^ (1 + 1 / K)) ^ 0.5
    c2 = (2 * g * K / (K - 1)) ^ 0.5
    
    Dim A As Double
    A = Application.PI * d_in ^ 2 / 4 'area of choke, sq in.
    
    Dim Qg_crit As Double
    Qg_crit = 155.5 * CD * A * Pu_psi * c1 * c2 / (gamma_g * (Tu_F + 460)) ^ 0.5 'critical flow ratio, Mcf/d
    
    Dim Pd_Pu As Double
    Pd_Pu = Pd_atma / Pu_atma
    
    If Pd_Pu >= 1 Then
        GL_Qgasvalve_m3day = 0
        Exit Function
    End If
    
    If Pd_Pu <= 0 Then
        GL_Qgasvalve_m3day = 0
        Exit Function
    End If
    
    If Pd_Pu <= Pd_Pu_crit Then
        GL_Qgasvalve_m3day = Qg_crit * 28.31993658
    Else
        c0 = ((Pd_Pu ^ (2 / K) - Pd_Pu ^ (1 + 1 / K))) ^ 0.5
        GL_Qgasvalve_m3day = Qg_crit * 28.31993658 * c0 / c1
    End If
End Function
Public Function GL_Pd_gas_valve_atma(d_mm As Double, Pu_atma As Double, Qg_m3day As Double, gamma_g As Double, Tu_C As Double)
' расчет перепада давления на клапане при проходе газа через него
Dim Qmax_m3day As Double, Qtest_m3day As Double
Dim Pd As Double, Pd2 As Double, Pd1 As Double
Pd = 1
    Dim K As Double
    K = 1.31   ' = Cp/Cv (approx 1.31 for natural gases(R Brown) or 1.25 (Mischenko) )
    Dim Pd_Pu_crit As Double
    Pd_Pu_crit = (2 / (K + 1)) ^ (K / (K - 1))
'    Dim Pd_Pu As Double
'    Pd_Pu = Pd_atma / Pu_atma
 Dim i As Integer
 i = 0
Qmax_m3day = GL_Qgasvalve_m3day(d_mm, Pu_atma, Pd, gamma_g, Tu_C)
If Qmax_m3day > Qg_m3day Then
    Pd1 = Pd_Pu_crit * Pu_atma
    Pd2 = Pu_atma
    Do
        i = i + 1
        Pd = (Pd2 + Pd1) / 2
        Qtest_m3day = GL_Qgasvalve_m3day(d_mm, Pu_atma, Pd, gamma_g, Tu_C)
        If Qg_m3day > Qtest_m3day Then
            Pd2 = Pd
        Else
            Pd1 = Pd
        End If
    Loop While (Abs(Qg_m3day - Qtest_m3day) > 0.01) And (i < 100)
    GL_Pd_gas_valve_atma = Pd
Else
    GL_Pd_gas_valve_atma = Pu_atma
End If
End Function
    
' функция расчета коэффициента Джоуля Томсона
Public Function PVT_CJT_Katm(P_atma, T_C, _
                    Optional gamma_gas = const_gamma_gas_default, _
                    Optional gamma_oil = const_gamma_oil_default, _
                    Optional gamma_wat = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Ql_m3day As Double = 10, _
                    Optional wc_perc As Double = 0, _
                    Optional PVTcorr = StandingBased) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
'
' опциональные аргументы фукнции
' gamma_gas        удельная плотность газа, по воздуху.
'               const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'               const_gamma_oil_default = 0.86
' gamma_wat        удельная плоность воды, по воде.
'               const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'               const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3. Калибровочный параметр.
'           По умолчанию не задается, рассчитывается по газосодержанию
' Pb_atma    давление насыщения, атм. Калибровочный параметр.
'           По умолчанию не задается, рассчитывается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'               const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3. Калибровочный параметрв.
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций используемых для расчета
'               StandingBased = 0 - на основе кор-ии Стендинга
'               McCainBased = 1 - на основе кор-ии Маккейна
'               StraigthLine = 2 - на основе упрощенных зависимостей
'
' выходное значение - число - объемный коэффициент газа при заданных
'           термобарических условиях, м3/м3.
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3
    PVT.Qliq_scm3day = Ql_m3day
    PVT.wc_perc = wc_perc
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    PVT_CJT_Katm = PVT.CJT_Katm
End Function
