'=======================================================================================
'Unifloc7.5  Boinae                                           khabibullin.ra@gubkin.ru
'Библиотека расчетных модулей по нефтяному инжинирингу
'2000 - 2019 гг
'
'=======================================================================================
' функции для проведения расчетов из интерфейса Excel
Option Explicit
' переменные для оптимизации работы интерфейсных функций с базой ЭЦН
' должны позволить сохранить данные загруженные из базы для работы тестов и макросов
Public Function StartLog()
End Function
' функция расчета объемного коэффициента газа
Public Function PVT_Bg_m3m3(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' Возвращает значение объемного коэффициента газа, м3/м3
' для заданных термобарических условий.
' В основе расчета корреляция для z факотора
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Bg_m3m3 = PVT.Bg_m3m3
End Function
' расчет объемного коэффициента нефти
Public Function PVT_Bo_m3m3(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает значение объемного коэффициента нефти, м3/м3
' для заданных термобарических условий.
' В основе расчета корреляции PVT
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Bo_m3m3 = PVT.Bo_m3m3
End Function
' расчет объемного коэффициента воды
Public Function PVT_Bw_m3m3(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает значение объемного коэффициента воды, м3/м3
' для заданных термобарических условий.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Bw_m3m3 = PVT.Bw_m3m3
End Function
' расчет объемного коэффициента воды
Public Function PVT_Sal_ppm(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает соленость воды, ppm
' для заданных термобарических условий.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Sal_ppm = PVT.Sal_ppm
End Function
' расчет вязкости нефти
Public Function PVT_Muo_cP(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - вязкость нефти
'           при заданных термобарических условиях, сП
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Muo_cP = PVT.Muo_cP
End Function
' расчет вязкости газа
Public Function PVT_Mug_cP(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - вязкость газа
'           при заданных термобарических условиях, сП
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Mug_cP = PVT.Mug_cP
End Function
' расчет вязкости воды
Public Function PVT_Muw_cP(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - вязкость воды
'           при заданных термобарических условиях, сП
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Muw_cP = PVT.Muw_cP
End Function
' расчет газосодержания
Public Function PVT_Rs_m3m3(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - газосодержание при
'           заданных термобарических условиях, м3/м3.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Rs_m3m3 = PVT.rs_m3m3
End Function
' расчет коэффициента сверхсжимаемости газа
Public Function PVT_Z(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - z фактор газа.
'           коэффициент сверхсжимаемости газа,
'           безразмерная величина
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Z = PVT.z
End Function
' расчет плотности нефти
Public Function PVT_Rhoo_kgm3(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - плотность нефти
'           при заданных термобарических условиях, кг/м3.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Rhoo_kgm3 = PVT.rho_oil_kgm3
End Function
' расчет плотности газа
Public Function PVT_Rhog_kgm3(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - плотность газа
'           при заданных термобарических условиях, кг/м3.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Rhog_kgm3 = PVT.rho_gas_kgm3
End Function
' расчет плотности воды
Public Function PVT_Rhow_kgm3(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - плотность воды
'           при заданных термобарических условиях, кг/м3.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_Rhow_kgm3 = PVT.rho_water_kgm3
End Function
' Расчет давления насыщения
Public Function PVT_Pb_atma(T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - давление насыщения.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    
    PVT_Pb_atma = PVT.Calc_Pb_atma(rsb_m3m3, T_C)
End Function
' расчет коэффициента поверхностного натяжения нефть - газ
Public Function PVT_SToilgas_Nm(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает коэффициента поверхностного натяжения нефть - газ, Нм
' для заданных термобарических условий.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_SToilgas_Nm = PVT.sigma_o_Nm
End Function
' расчет коэффициента поверхностного натяжения вода - газ
Public Function PVT_STwatgas_Nm(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает коэффициента поверхностного натяжения вода - газ, Нм
' для заданных термобарических условий.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_STwatgas_Nm = PVT.sigma_w_Nm
End Function
' расчет коэффициента поверхностного натяжения жидкость - газ
Public Function PVT_STliqgas_Nm(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает коэффициента поверхностного натяжения жидкость - газ, Нм
' для заданных термобарических условий.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    PVT_STliqgas_Nm = PVT.sigma_liq_Nm
End Function
' расчет объемного расхода газожидкостной смеси для заданных термобарических условий
Public Function MF_Qmix_m3day(Qliq_m3day, wc_perc, P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' Qliq_m3day дебит жидкости на поверхности
' wc_perc   объемная обводненность
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - объемный расход ГЖС, м3/сут.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
     
    PVT.wc_perc = wc_perc
    PVT.Qliq_scm3day = Qliq_m3day
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    MF_Qmix_m3day = PVT.Qmix_m3day
End Function
' расчет плотности газожидкостной смеси для заданных  условий
Public Function MF_Rhomix_kgm3(Qliq_m3day, wc_perc, P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' Qliq_m3day дебит жидкости на поверхности
' wc_perc   объемная обводненность
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - плотность ГЖС, кг/м3.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
     
    PVT.wc_perc = wc_perc
    PVT.Qliq_scm3day = Qliq_m3day
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
        
    MF_Rhomix_kgm3 = PVT.rho_mix_kgm3
End Function
' расчет вязкости газожидкостной смеси для заданных термобарических условий
Public Function MF_Mumix_cP(Qliq_m3day, wc_perc, P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' Qliq_m3day дебит жидкости на поверхности
' wc_perc   объемная обводненность
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - объемный расход ГЖС, м3/сут.
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
     
    PVT.wc_perc = wc_perc
    PVT.Qliq_scm3day = Qliq_m3day
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    
    MF_Mumix_cP = PVT.MuMix_cP
End Function
' расчет доли газа в потоке
Public Function MF_GasFraction_d(P_atma, T_C, _
                    Optional wc_perc = 0, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
' wc_perc   обводненность объемная
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
'  выходное значение - число - доля газа в потоке
' (расходная без проскальзования)
    Dim PVT As CPVT
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    PVT.wc_perc = wc_perc
    
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    MF_GasFraction_d = PVT.GasFraction_d(0)
End Function
' расчет давления при котором достигается заданная доля газа в потоке
Public Function MF_PGasFraction_atma(FreeGas_d, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional wc_perc = 0, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' FreeGas_d допустимая доля газа в потоке
' Т_C       температура, С.
' опциональные аргументы функции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - давление, атма.
    Dim PVT As CPVT
    Dim t As Double
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    PVT.wc_perc = wc_perc
    
    t = T_C
    MF_PGasFraction_atma = PVT.PGasFraction_atma(FreeGas_d, t)
End Function
' расчет газового фактора
' при котором достигается заданная доля газа в потоке
Public Function MF_RpGasFraction_m3m3(FreeGas_d, P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional wc_perc = 0, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Muob_cP As Double = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr As Double = 0, _
                    Optional PKsep_atma As Double = -1, _
                    Optional TKsep_C As Double = -1, _
                    Optional PVTstr As String = "" _
                    ) As Double
' обязательные аргументы функции
' FreeGas_d допустимая доля газа в потоке
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы функции
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - газовый фактор, м3/м3.
    Dim PVT As CPVT
    Dim t As Double, P As Double
    If PVTstr <> "" Then
        Set PVT = PVT_Decode_string(PVTstr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        PVT.wc_perc = wc_perc
    End If
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
        Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    PVT.wc_perc = wc_perc
    t = T_C
    P = P_atma
    MF_RpGasFraction_m3m3 = PVT.RpGasFraction_m3m3(FreeGas_d, P, t)
End Function
' расчет натуральной сепарации газа на приеме насоса
Public Function MF_SeparNat_d(Pin_atma As Double, _
        Qliq_m3day As Double, fw_perc, _
        Optional Tin_C As Double = 50, _
        Optional dIntake_mm As Double = 90, _
        Optional dCas_mm As Double = 120, _
        Optional gamma_gas As Double = const_gamma_gas_default, _
        Optional gamma_oil As Double = const_gamma_oil_default, _
        Optional gamma_wat As Double = const_gamma_wat_default, _
        Optional rsb_m3m3 = const_Rsb_default, _
        Optional Rp_m3m3 As Double = -1, _
        Optional Pb_atma As Double = -1, _
        Optional Tres_C As Double = const_Tres_default, _
        Optional Bob_m3m3 As Double = -1, _
        Optional Muob_cP As Double = -1, _
        Optional PVTcorr = StandingBased) As Double
'----------------------------------------------------------------
' Pin_atma       - давление сепарации
' Qliq_m3day    - дебит жидкости в поверхностных условиях
' fw_perc      - обводненность
' Tin_C         - температура сепарации
' dintake_mm    - диаметр приемной сетки
' dcas_mm       - диаметр эксплуатационной колонны
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
    Dim Fluid As New CPVT
    Call Fluid.SetRpRsb(Rp_m3m3, CDbl(rsb_m3m3))
    Fluid.Pb_atma = Pb_atma
    Fluid.Tres_C = Tres_C
    Fluid.PVT_CORRELATION = PVTcorr
    Fluid.Bob_m3m3 = Bob_m3m3
    Fluid.gamma_g = gamma_gas
    Fluid.gamma_o = gamma_oil
    Fluid.gamma_w = gamma_wat
    
    Fluid.Qliq_scm3day = Qliq_m3day
    Fluid.wc_perc = fw_perc
    
    Call Fluid.Calc_PVT(Pin_atma, Tin_C)
    With Fluid
        MF_SeparNat_d = unf_calc_natural_separation(dIntake_mm / 1000, dCas_mm / 1000, .Qliq_scm3day, .Qgas_scm3day, .Bo_m3m3, .Bg_m3m3, .sigma_o_Nm, .RhoOil_sckgm3, .rhoGas_sckgm3, .wc_perc)
    End With
    
End Function
Public Function MF_SeparTotal_d(SepNat As Double, _
                        SepGasSep As Double) As Double
' SepNat        - естественная сепарация
' SepGasSep     - искусственная сепарация (газосепаратор)
    MF_SeparTotal_d = SepNat + (1 - SepNat) * SepGasSep
End Function
Public Function MF_PrGrad(ByVal d_m As Double, _
             ByVal P_atma As Double, _
             ByVal Ql_rc_m3day As Double, _
             ByVal Qg_rc_m3day As Double, _
            Optional ByVal Muo_cP As Double = const_mu_o, _
            Optional ByVal Mug_cP As Double = const_mu_g, _
            Optional ByVal sigma_o_Nm As Double = const_sigma_oil_Nm, _
            Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
            Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
            Optional ByVal eps_m As Double = 0.0001, _
            Optional ByVal theta_deg As Double = 90, _
            Optional ByVal ZNLF As Boolean = False)
' расчет градиента давления по одной из корреляций
' объемные коэффициенты по умолчанию заданы равными единицам - если их не трогать, значит дебиты в рабочих условиях
' газосодержание равно нулю по умолчанию - значит весь газ который указан идет в потоке
' пока только для Ансари - потом можно распространить и на другие методы
Dim rho_osc_kgm3 As Double
Dim rho_gsc_kgm3 As Double
Dim dPdLg_out_atmm As Double
Dim dPdLf_out_atmm As Double
Dim Vsl_out_msec As Double
Dim Vsg_out_msec As Double
Dim Hl_out_fr As Double
Dim fpat_out_num
Dim dPdLa_out_atmm As Double
Dim PrGrad
rho_osc_kgm3 = gamma_oil * const_rho_ref
rho_gsc_kgm3 = gamma_gas * const_rho_air
On Error GoTo er1:
    PrGrad = unf_AnsariGradient(d_m, theta_deg, eps_m, _
                                Ql_rc_m3day, Qg_rc_m3day, _
                                Muo_cP, Mug_cP, _
                                sigma_o_Nm, _
                                rho_osc_kgm3, _
                                rho_gsc_kgm3, _
                                P_atma)
    
    MF_PrGrad = PrGrad
    
Exit Function
er1:
MF_PrGrad = 0
End Function
'  расчет перепада давления и распределения температуры в трубе
'  с использованием многофазных корреляций
Public Function MF_dPpipe_atm(Q_m3Day, fw_perc, _
                Hmes0_m As Double, Hmes1_m As Double, _
                Pcalc_atma As Double, _
                Optional Tcalc_C As Double = 50, _
                Optional theta_deg As Double = 90, _
                Optional d_mm As Double = 60, _
                Optional roughness_m As Double = 0.0001, _
                Optional gamma_gas As Double = const_gamma_gas_default, _
                Optional gamma_oil As Double = const_gamma_oil_default, _
                Optional gamma_wat As Double = const_gamma_wat_default, _
                Optional rsb_m3m3 = const_Rsb_default, _
                Optional Rp_m3m3 As Double = -1, _
                Optional Pb_atma As Double = -1, _
                Optional Tres_C As Double = const_Tres_default, _
                Optional Bob_m3m3 As Double = -1, _
                Optional Muob_cP As Double = -1, _
                Optional PVTcorr = StandingBased, _
                Optional Ksep_fr As Double = 0, _
                Optional PKsep_atma As Double = -1, _
                Optional TKsep_C As Double = -1, _
                Optional HydrCorr As H_CORRELATION = 0, _
                Optional Tother_C As Double = -1, _
                Optional betta_grav = 1, Optional betta_fric = 1)
'
'
' Обязательные параметры
' Q_m3Day       - дебит жидкости в поверхностных условиях
' fw_perc      - обводненность
' Hmes0_m       - начальная координата трубы, м
' Hmes1_m       - конечная координата трубы, м
'                 расчет всегда ведется от начальной координаты к
'                 конечной. если Hmes0_m < Hmes1_m то расчет
'                 идет сверху вниз для вертикальной трубы
'                 иначе расчет идет снизу вверх
' Pcalc_atma    - давление с которого начинается расчет, атм
'                 граничное значение для проведения расчета
' Необязательные параметры
' стандартные набор PVT параметров
' Tcalc_C       - температура в точке где задано давление, С
' theta_deg     - угол направления потока к горизонтали
'                 (90 - вертикальная труба вверх)
'                 может принимать отрицательные значения
' d_mm          - внутрнний диаметр трубы
' roughness_m   - шероховатость трубы
' gamma_gas     - удельная плотность газа, по воздуху.
'                   const_gamma_gas_default = 0.6
' gamma_oil     - удельная плотность нефти, по воде.
'                   const_gamma_oil_default = 0.86
' gamma_wat     - удельная плотность воды, по воде.
'                   const_gamma_wat_default = 1
' Rsb_m3m3      - газосодержание при давлении насыщения, м3/м3.
'                   const_Rsb_default = 100
' Rp_m3m3       - замерной газовый фактор, м3/м3.
' Pb_atma       - давление насыщения, атм. Калибровочный параметр.
' Tres_C        - пластовая температура, С.
'                 Учитывается при расчете давления насыщения.
' Bob_m3m3      - объемный коэффициент нефти, м3/м3.
' Muob_cP       - вязкость нефти при давлении насыщения
'                 По умолчанию рассчитывается по корреляции
' PVTcorr       - номер набора PVT корреляций для расчета
'                 StandingBased = 0 - на основе кор-ии Стендинга
'                 McCainBased = 1 - на основе кор-ии Маккейна
'                 StraigthLine = 2 - упрощенные зависимости
' Ksep_fr       - коэффициент сепарации - определяет изменение
'               свойств нефти после сепарации  доли  газа.
'               изменение свойств нефти зависит от условий
'               сепарация газа, которые должны быть явно заданы
' PKsep_atma    - давление при которой была сепарация
' TKsep_C       - температура при которой была сепарация
' HydrCorr      - гидравлическая корреляция, H_CORRELATION
'                   BeggsBriilCor = 0
'                   AnsariCor = 1
'                   UnifiedCor = 2
'                   Gray = 3
'                   HagedornBrown = 4
'                   SakharovMokhov = 5
' Tother_C      - температура на другом конце трубы
'                 по умолчанию температура вдоль трубы постоянна
'                 если задано то меняется линейно по трубе
' выходное значение - число - давление на другом конце трубы atma.
    Dim dPT(2) As Double
    Dim PT
    PT = MF_Ppipe_atma(Q_m3Day, fw_perc, _
                Hmes0_m, Hmes1_m, _
                Pcalc_atma, _
                 Tcalc_C, _
                 theta_deg, _
                 d_mm, _
                 roughness_m, _
                 gamma_gas, _
                 gamma_oil, _
                 gamma_wat, _
                 rsb_m3m3, _
                 Rp_m3m3, _
                 Pb_atma, _
                 Tres_C, _
                 Bob_m3m3, _
                 Muob_cP, _
                 PVTcorr, _
                 Ksep_fr, _
                 PKsep_atma, _
                 TKsep_C, _
                 HydrCorr, _
                 Tother_C, _
                 betta_grav, betta_fric)
                 
    If Hmes0_m < Hmes1_m Then
        dPT(0) = PT(0) - Pcalc_atma
        dPT(1) = PT(1) - Tcalc_C
    Else
        dPT(0) = Pcalc_atma - PT(0)
        dPT(1) = Tcalc_C - PT(1)
    End If
    
    MF_dPpipe_atm = dPT
End Function
'  расчет давления и распределения температуры в трубе
'  с использованием многофазных корреляций
Public Function MF_Ppipe_atma(Q_m3Day, fw_perc, _
                Hmes0_m As Double, Hmes1_m As Double, _
                Pcalc_atma As Double, _
                Optional Tcalc_C As Double = 50, _
                Optional theta_deg As Double = 90, _
                Optional d_mm As Double = 60, _
                Optional roughness_m As Double = 0.0001, _
                Optional gamma_gas As Double = const_gamma_gas_default, _
                Optional gamma_oil As Double = const_gamma_oil_default, _
                Optional gamma_wat As Double = const_gamma_wat_default, _
                Optional rsb_m3m3 = const_Rsb_default, _
                Optional Rp_m3m3 As Double = -1, _
                Optional Pb_atma As Double = -1, _
                Optional Tres_C As Double = const_Tres_default, _
                Optional Bob_m3m3 As Double = -1, _
                Optional Muob_cP As Double = -1, _
                Optional PVTcorr = StandingBased, _
                Optional Ksep_fr As Double = 0, _
                Optional PKsep_atma As Double = -1, _
                Optional TKsep_C As Double = -1, _
                Optional HydrCorr As H_CORRELATION = 0, _
                Optional Tother_C As Double = -1, _
                Optional betta_grav = 1, Optional betta_fric = 1)
'
' Обязательные параметры
' Q_m3Day       - дебит жидкости в поверхностных условиях
' fw_perc       - обводненность
' Hmes0_m       - начальная координата трубы, м
' Hmes1_m       - конечная координата трубы, м
'                 расчет всегда ведется от начальной координаты к
'                 конечной. если Hmes0_m < Hmes1_m то расчет
'                 идет сверху вниз для вертикальной трубы
'                 иначе расчет идет снизу вверх
' Pcalc_atma    - давление с которого начинается расчет, атм
'                 граничное значение для проведения расчета
' Необязательные параметры
' стандартные набор PVT параметров
' Tcalc_C       - температура в точке где задано давление, С
' theta_deg     - угол направления потока к горизонтали
'                 (90 - вертикальная труба вверх)
'                 может принимать отрицательные значения
' d_mm          - внутрнний диаметр трубы
' roughness_m   - шероховатость трубы
' gamma_gas     - удельная плотность газа, по воздуху.
'                   const_gamma_gas_default = 0.6
' gamma_oil     - удельная плотность нефти, по воде.
'                   const_gamma_oil_default = 0.86
' gamma_wat     - удельная плотность воды, по воде.
'                   const_gamma_wat_default = 1
' Rsb_m3m3      - газосодержание при давлении насыщения, м3/м3.
'                   const_Rsb_default = 100
' Rp_m3m3       - замерной газовый фактор, м3/м3.
' Pb_atma       - давление насыщения, атм. Калибровочный параметр.
' Tres_C        - пластовая температура, С.
'                 Учитывается при расчете давления насыщения.
' Bob_m3m3      - объемный коэффициент нефти, м3/м3.
' Muob_cP       - вязкость нефти при давлении насыщения
'                 По умолчанию рассчитывается по корреляции
' PVTcorr       - номер набора PVT корреляций для расчета
'                 StandingBased = 0 - на основе кор-ии Стендинга
'                 McCainBased = 1 - на основе кор-ии Маккейна
'                 StraigthLine = 2 - упрощенные зависимости
' Ksep_fr       - коэффициент сепарации - определяет изменение
'               свойств нефти после сепарации  доли  газа.
'               изменение свойств нефти зависит от условий
'               сепарация газа, которые должны быть явно заданы
' PKsep_atma    - давление при которой была сепарация
' TKsep_C       - температура при которой была сепарация
' HydrCorr      - гидравлическая корреляция, H_CORRELATION
'                   BeggsBriilCor = 0
'                   AnsariCor = 1
'                   UnifiedCor = 2
'                   Gray = 3
'                   HagedornBrown = 4
'                   SakharovMokhov = 5
' Tother_C      - температура на другом конце трубы
'                 по умолчанию температура вдоль трубы постоянна
'                 если задано то меняется линейно по трубе
' выходное значение - число - давление на другом конце трубы atma.
On Error GoTo err1:
    ' first check trivial initial data
    If Hmes0_m = Hmes1_m Then
        MF_Ppipe_atma = Array(Pcalc_atma, Tcalc_C)
        Exit Function
    End If
    Dim Pipe As New CPipe
    Dim PVT As New CPVT
    Dim PTcalc As PTtype
    Dim TM As TEMP_CALC_METHOD
    ' initialize PVT properties
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
        Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    PVT.PVT_CORRELATION = PVTcorr
    PVT.Qliq_scm3day = Q_m3Day
    PVT.wc_perc = fw_perc
    Set Pipe.Fluid = PVT
    ' initialize boundary conditions
    PTcalc.P_atma = Pcalc_atma
    PTcalc.T_C = Tcalc_C
    If Tother_C < 0 Then Tother_C = Tcalc_C
    ' initialize geometry
    Call Pipe.InitPipe(d_mm / 1000, Hmes0_m, Hmes1_m, theta_deg, roughness_m)
    If Hmes0_m < Hmes1_m Then
        Pipe.Param = ParamCalcFromTop(HydrCorr, TempMeth:=StartEndTemp)
    Else
        Pipe.Param = ParamCalcFromBottom(HydrCorr, TempMeth:=StartEndTemp)
    End If
    Pipe.InitTlinear Tcalc_C, Tother_C
    Pipe.betta_grav = betta_grav
    Pipe.betta_fric = betta_fric
    ' calc pressure distribution
    MF_Ppipe_atma = ArrayOut(Pipe.Calc_dPipe(PTcalc, noCurves))
    
    Exit Function
err1:
    MF_Ppipe_atma = Array(Pcalc_atma, Tcalc_C)
    addLogMsg ("ошибка при расчете dPipe")
End Function
Private Function ArrayOut(PT As PTtype)
    ArrayOut = Array(PT.P_atma, PT.T_C)
End Function
' ==============  функции для расчета штуцера ==========================
' =====================================================================
'
' Расчет перепада давления в штуцере (по потоку)
' Расчет перепада давления в штуцере (по потоку)
Public Function MF_dPChoke_atm(dPipe_mm, dchoke_mm, _
            Pin_atma, Pout_atma, _
            Qliq_m3day, fw_perc, _
            Optional Tchoke_C As Double = 20, _
            Optional Calc_from_P0 As Boolean = True, _
            Optional gamma_gas As Double = const_gamma_gas_default, _
            Optional gamma_oil As Double = const_gamma_oil_default, _
            Optional gamma_wat As Double = const_gamma_wat_default, _
            Optional rsb_m3m3 = const_Rsb_default, _
            Optional Rp_m3m3 As Double = -1, _
            Optional Pb_atma As Double = -1, _
            Optional Tres_C As Double = const_Tres_default, _
            Optional Bob_m3m3 As Double = -1, _
            Optional Muob_cP As Double = -1, _
            Optional PVTcorr = StandingBased, _
            Optional Ksep_fr As Double = 0, _
            Optional PKsep_atma As Double = -1, _
            Optional TKsep_C As Double = -1)
            
    Dim PT
    Dim dPT(2) As Double
    
    PT = MF_PChoke_atm(dPipe_mm, dchoke_mm, _
            Pin_atma, Pout_atma, _
            Qliq_m3day, fw_perc, _
            Tchoke_C, _
            Calc_from_P0, _
            gamma_gas, _
            gamma_oil, _
            gamma_wat, _
            rsb_m3m3, _
            Rp_m3m3, _
            Pb_atma, _
            Tres_C, _
            Bob_m3m3, _
            Muob_cP, _
            PVTcorr, _
            Ksep_fr, _
            PKsep_atma, _
            TKsep_C)
    If Calc_from_P0 Then
        dPT(0) = Pin_atma - PT(0)
    Else
        dPT(0) = PT(0) - Pout_atma
    End If
    dPT(1) = PT(1) - Tchoke_C
    
    MF_dPChoke_atm = dPT
    
End Function
' расчет давления в штуцере
Public Function MF_PChoke_atm(dPipe_mm, dchoke_mm, _
            Pin_atma, Pout_atma, _
            Qliq_m3day, fw_perc, _
            Optional Tchoke_C As Double = 20, _
            Optional Calc_from_P0 As Boolean = True, _
            Optional gamma_gas As Double = const_gamma_gas_default, _
            Optional gamma_oil As Double = const_gamma_oil_default, _
            Optional gamma_wat As Double = const_gamma_wat_default, _
            Optional rsb_m3m3 = const_Rsb_default, _
            Optional Rp_m3m3 As Double = -1, _
            Optional Pb_atma As Double = -1, _
            Optional Tres_C As Double = const_Tres_default, _
            Optional Bob_m3m3 As Double = -1, _
            Optional Muob_cP As Double = -1, _
            Optional PVTcorr = StandingBased, _
            Optional Ksep_fr As Double = 0, _
            Optional PKsep_atma As Double = -1, _
            Optional TKsep_C As Double = -1)
' dPipe_mm      - диаметр трубы до и после штуцера
' dChoke_mm     - диаметр штуцера (эффективный)
' Pin_atma       - давление на входе (высокой стороне)
' Pout_atma       - давление на выходе (низкой стороне)
' Qliq_m3day    - дебит жидкости в пов условиях
' fw_perc      - обводненность
' опциональные аргументы функции
' Tchoke_C      - температура, С.
' Calc_from_P0 - показывает направление расчета штуцера
' gamma_gas        удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat        удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
' Pb_atma   давление насыщения, атм. Калибровочный параметр.
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'       нефти после сепарации определенной доли свободного газа.
'       изменение свойств нефти зависит от условий при которых
'       произошла сепарация газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' выходное значение - число - перепад давления на штуцере.
    Dim Choke As New Cchoke
    Dim PT As PTtype
    Call Choke.Fluid.SetRpRsb(Rp_m3m3, CDbl(rsb_m3m3))
    Choke.Fluid.Pb_atma = Pb_atma
    Choke.Fluid.Tres_C = Tres_C
    Choke.Fluid.PVT_CORRELATION = PVTcorr
    Choke.Fluid.Bob_m3m3 = Bob_m3m3
    Choke.Fluid.gamma_g = gamma_gas
    Choke.Fluid.gamma_o = gamma_oil
    Choke.Fluid.gamma_w = gamma_wat
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
        Call Choke.Fluid.ModAfterSeparation(PKsep_atma, TKsep_C, _
                                            Ksep_fr, GasGoesIntoSolution)
    End If
    Choke.Fluid.Qliq_scm3day = Qliq_m3day
    Choke.Fluid.wc_perc = fw_perc
    
    Choke.Ddown_m = dPipe_mm / 1000
    Choke.Dup_m = dPipe_mm / 1000
    Choke.Dchoke_m = dchoke_mm / 1000
    
    If Calc_from_P0 Then
        PT = Choke.Calc_Choke_Plin(SetPT(Pin_atma, Tchoke_C))
    Else
        PT = Choke.Calc_Choke_Pbuf(SetPT(Pout_atma, Tchoke_C))
    End If
    
    MF_PChoke_atm = Array(PT.P_atma, PT.T_C)   ' на выходе выдаем массив
End Function
'' Расчет перепада давления в штуцере (против потока)
'Public Function MF_dPChokeUp_atma(dPipe_mm, dchoke_mm, Pdown_atma, Qliq_m3day, fw_perc, _
'                        Optional Tchoke_C = 20, _
'                        Optional gamma_gas as double = const_gamma_gas_default, _
'                        Optional gamma_oil as double = const_gamma_oil_default, _
'                        Optional gamma_wat as double = const_gamma_wat_default, _
'                        Optional Rsb_m3m3 = const_Rsb_default, _
'                        Optional Rp_m3m3 As Double = -1, _
'                        Optional Pb_atma As Double = -1, _
'                        Optional Tres_C As Double = const_Tres_default, _
'                        Optional Bob_m3m3 As Double = -1, _
'                        Optional Muob_cP As Double = -1, _
'                        Optional PVTcorr = StandingBased, _
'                        Optional Ksep_fr As Double = 0, _
'                        Optional PKsep_atma As Double = -1, _
'                        Optional TKsep_C As Double = -1)
'
'' dPipe_mm      - диаметр трубы до и после штуцера
'' dChoke_mm     - диаметр штуцера (эффективный)
'' Pdown_atma     - давление на выходе (низкой стороне)
'' Qliq_m3day    - дебит жидкости в пов условиях
'' fw_perc      - обводненность
'' данные PVT
'    Dim choke As New Cchoke
'    Dim PT As PTtype
'    Call choke.Fluid.SetRpRsb(Rp_m3m3, Rsb_m3m3)
'    choke.Fluid.Pb_atma = Pb_atma
'    choke.Fluid.Tres_C = Tres_C
'    choke.Fluid.PVT_CORRELATION = PVTcorr
'    choke.Fluid.Bob_m3m3 = Bob_m3m3
'    choke.Fluid.gamma_g = gamma_gas
'    choke.Fluid.gamma_o = gamma_oil
'    choke.Fluid.gamma_w = gamma_wat
'    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
''        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
'        Call choke.Fluid.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
'    End If
'    choke.Ddown_m = dPipe_mm / 1000
'    choke.Dup_m = dPipe_mm / 1000
'    choke.Dchoke_m = dchoke_mm / 1000
'
'    choke.Fluid.Qliq_scm3day = Qliq_m3day
'    choke.Fluid.wc_perc = fw_perc
'    PT = choke.Calc_Choke_Pbuf(SetPT(Pdown_atma, Tchoke_C))
'    MF_dPChokeUp_atma = Array(PT.P_atma, PT.T_C)   ' на выходе выдаем массив
'
'
'End Function
 ' функция расчета дебита жидкости через штуцер
Public Function MF_QChoke_m3day(dPipe_mm, dchoke_mm, Pup_atma, Pdown_atma, fw_perc, _
                        Optional Tchoke_C = 20, _
                        Optional gamma_gas As Double = const_gamma_gas_default, _
                        Optional gamma_oil As Double = const_gamma_oil_default, _
                        Optional gamma_wat As Double = const_gamma_wat_default, _
                        Optional rsb_m3m3 = const_Rsb_default, _
                        Optional Rp_m3m3 As Double = -1, _
                        Optional Pb_atma As Double = -1, _
                        Optional Tres_C As Double = const_Tres_default, _
                        Optional Bob_m3m3 As Double = -1, _
                        Optional Muob_cP As Double = -1, _
                        Optional PVTcorr = StandingBased, _
                        Optional Ksep_fr As Double = 0, _
                        Optional PKsep_atma As Double = -1, _
                        Optional TKsep_C As Double = -1)
' dPipe_mm      - диаметр трубы до и после штуцера
' dChoke_mm     - диаметр штуцера (эффективный)
' Pdown_atma     - давление на выходе (низкой стороне)
' Pup_atma       - давление на входе (высокой стороне)
' fw_perc      - обводненность
' данные PVT
                       
    Dim Choke As New Cchoke
    Call Choke.Fluid.SetRpRsb(Rp_m3m3, CDbl(rsb_m3m3))
    Choke.Fluid.Pb_atma = Pb_atma
    Choke.Fluid.Tres_C = Tres_C
    Choke.Fluid.PVT_CORRELATION = PVTcorr
    Choke.Fluid.Bob_m3m3 = Bob_m3m3
    Choke.Fluid.gamma_g = gamma_gas
    Choke.Fluid.gamma_o = gamma_oil
    Choke.Fluid.gamma_w = gamma_wat
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
'        Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
        Call Choke.Fluid.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    Choke.Ddown_m = dPipe_mm / 1000
    Choke.Dup_m = dPipe_mm / 1000
    Choke.Dchoke_m = dchoke_mm / 1000
    
'    choke.Fluid.Qliq_scm3day = Qliq_m3day
    Choke.Fluid.wc_perc = fw_perc
    On Error GoTo er1:
    
    MF_QChoke_m3day = Choke.Choke_liquid_rate(Pup_atma, Pdown_atma, Tchoke_C)
    Exit Function
er1:
    addLogMsg "QChoke_m3day: Расчет дебита через штуцер завершился с ошибкой Pup_atm=" & Pup_atma & " Pup_atma =" & Pdown_atma
    MF_QChoke_m3day = 0
    
End Function
' ==============  функции для расчета скважины ==========================
' =====================================================================
Private Function InitWellData(Q_m3Day, _
                      Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional dCas_mm = 127, Optional dtub_mm = 62, Optional dchoke_mm = -1, _
                      Optional fw_perc = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                      Optional gamma_oil As Double = const_gamma_oil_default, Optional gamma_wat As Double = const_gamma_wat_default, Optional gamma_gas As Double = const_gamma_gas_default, _
                      Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
                      Optional roughness_m As Double = 0.0001, _
                      Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional esp_freq_Hz = 50, _
                      Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0, Optional Ksep_fr As Double = 0) As CWell
    Dim well As New CWell
    Dim PVT As New CPVT
    Dim pmp As CESPpump
    Dim ESPsystem As CESPsystemSimple
    
    PVT.gamma_g = gamma_gas
    PVT.gamma_o = gamma_oil
    PVT.gamma_w = gamma_wat
    PVT.Tres_C = Tres_C
    
    Call PVT.SetRpRsb(Rp_m3m3, rsb_m3m3)
    PVT.Pb_atma = Pb_atma
    PVT.PVT_CORRELATION = PVTcorr
    PVT.Qliq_scm3day = Q_m3Day
    PVT.wc_perc = fw_perc
    Set well.Fluid = PVT
    well.HFlowCorrelation = HydrCorr
    well.TempCorrelation = StartEndTemp ' AmbientTemp
    well.InitWell Hperf_m, Hpump_m, Udl_m, dCas_mm, dtub_mm, Tbh_C, Twh_C
    well.SetChoke dchoke_mm, dtub_mm
    If ESP_ID > 0 Then
        If checkID_ESP(ESP_ID) Then
             Set pmp = getESP(ESP_ID)
             pmp.StageNum = ESP_numStages
             pmp.freq_Hz = esp_freq_Hz
             Set well.ESP.ESPpump = pmp
             
             'well.IsESP = True
        End If
    End If
    If Ksep_fr > 0 Then
        'well.ESP.isKsepManual = True
        'well.ESP.GasSeparator.Ksep_fr = Ksep_fr
    End If
    Set InitWellData = well
End Function
Public Function Well_Plin_Pwf_atma(Pwf_atma, Q_m3Day, _
                      Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional dCas_mm = 127, Optional dtub_mm = 62, Optional dchoke_mm = -1, _
                      Optional fw_perc = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                      Optional gamma_oil As Double = const_gamma_oil_default, Optional gamma_wat As Double = const_gamma_wat_default, Optional gamma_gas As Double = const_gamma_gas_default, _
                      Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
                      Optional roughness_m As Double = 0.0001, _
                      Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional esp_freq_Hz = 50, _
                      Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0, Optional Ksep_fr As Double = 0, _
                      Optional Kdegr_d As Double = 0)
' функция расчета линейного давления скважины по забойному
    Dim well As CWell
    Set well = InitWellData(Q_m3Day, _
                       Hperf_m, Hpump_m, Udl_m, dCas_mm, dtub_mm, dchoke_mm, _
                       fw_perc, Rp_m3m3, rsb_m3m3, Pb_atma, Tres_C, _
                       gamma_oil, gamma_wat, gamma_gas, _
                       Bob_m3m3, Twh_C, Tbh_C, _
                       roughness_m, _
                       ESP_ID, ESP_numStages, esp_freq_Hz, _
                       PVTcorr, HydrCorr, Ksep_fr)
    'well.ESP.PressureDegradation = Kdegr_d
    Call well.Calc_Plin_Pwf_atma(SetPT(Pwf_atma, Tbh_C))     ' проведем расчет
    ' в качестве результата выведем ряд расчитанных значений давления
    With well
        Well_Plin_Pwf_atma = Array(Array(.Pline_atma, .Pbuf_atma, .Pdischarge_atma, .Pintake_atma, .Pwf_atma, "Давления атм, линейное, буферное, на приеме насоса, на выкиде насоса, забойное"), _
                                  Array(.Tsurf_C, .Twh_C, .Tdischarge_C, .Tintake_c, .Tbh_C, "Температура С, на поверхности, буферное, на приеме насоса, на выкиде насоса, забойное"))
    ' можно еще добавить сюда вывод кривых распределения давления и температуры по стволу и еще 4 параметров  (потом)
    End With
End Function
Public Function Well_calcKdegr_fr(Pwf_atma, Pbuf_atma, Q_m3Day, _
                      Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional dCas_mm = 127, Optional dtub_mm = 62, Optional dchoke_mm = -1, _
                      Optional fw_perc = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                      Optional gamma_oil As Double = const_gamma_oil_default, Optional gamma_wat As Double = const_gamma_wat_default, Optional gamma_gas As Double = const_gamma_gas_default, _
                      Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
                      Optional roughness_m As Double = 0.0001, _
                      Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional esp_freq_Hz = 50, _
                      Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0, Optional Ksep_fr As Double = 0)
' функция расчета линейного давления скважины по забойному
    Dim well As CWell
    Set well = InitWellData(Q_m3Day, _
                       Hperf_m, Hpump_m, Udl_m, dCas_mm, dtub_mm, dchoke_mm, _
                       fw_perc, Rp_m3m3, rsb_m3m3, Pb_atma, Tres_C, _
                       gamma_oil, gamma_wat, gamma_gas, _
                       Bob_m3m3, Twh_C, Tbh_C, _
                       roughness_m, _
                       ESP_ID, ESP_numStages, esp_freq_Hz, _
                       PVTcorr, HydrCorr, Ksep_fr)
'    Set well.Pbuf_atma = Pbuf_atma
    Call well.Calc_Well(Pbuf_atma, Pbuf_atma, Pwf_atma, Tbh_C, CalcChoke:=False)
'    Call well.fin(SetPT(Pwf_atma, Tbh_C))     ' проведем расчет
'    Call well.Calc_Plin_Pwf_atma(SetPT(Pwf_atma, Tbh_C))     ' проведем расчет
    ' в качестве результата выведем рад расчитанных значений давления
    With well
        Well_calcKdegr_fr = Array(Array(.ESPPressureDegradation, .Pline_atma, .Pbuf_atma, .Pdischarge_atma, .Pintake_atma, .Pwf_atma, "деградация ЭЦН ,Давления атм, линейное, буферное, на приеме насоса, на выкиде насоса, забойное"), _
                                  Array(.Kseptotal_d, .Tsurf_C, .Twh_C, .Tdischarge_C, .Tintake_c, .Tbh_C, "Ксеп,Температура С, на поверхности, буферное, на приеме насоса, на выкиде насоса, забойное"))
    ' можно еще добавить сюда вывод кривых распределения давления и температуры по стволу и еще 4 параметров  (потом)
    End With
End Function
Public Function Well_Pwf_Plin_atma(Plin_atma, Q_m3Day, _
                      Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional dCas_mm = 127, Optional dtub_mm = 62, Optional dchoke_mm = -1, _
                      Optional fw_perc = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                      Optional gamma_oil As Double = const_gamma_oil_default, Optional gamma_wat As Double = const_gamma_wat_default, Optional gamma_gas As Double = const_gamma_gas_default, _
                      Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
                      Optional roughness_m As Double = 0.0001, _
                      Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional esp_freq_Hz = 50, _
                      Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0, Optional Ksep_fr As Double = 0, _
                      Optional Kdegr_d As Double = 0)
' функция расчета забойному давления скважины по линейного
    Dim well As CWell
    Set well = InitWellData(Q_m3Day, _
                       Hperf_m, Hpump_m, Udl_m, dCas_mm, dtub_mm, dchoke_mm, _
                       fw_perc, Rp_m3m3, rsb_m3m3, Pb_atma, Tres_C, _
                       gamma_oil, gamma_wat, gamma_gas, _
                       Bob_m3m3, Twh_C, Tbh_C, _
                       roughness_m, _
                       ESP_ID, ESP_numStages, esp_freq_Hz, _
                       PVTcorr, HydrCorr, Ksep_fr)
    'well.ESP.PressureDegradation = Kdegr_d
    Call well.Calc_Pwf_Plin_atma(Plin_atma, Tbh_C, fast:=False)         ' проведем расчет
    ' в качестве результата выведем рад расчитанных значений давления
    With well
        Well_Pwf_Plin_atma = Array(Array(.Pwf_atma, .Pintake_atma, .Pdischarge_atma, .Pbuf_atma, .Pline_atma, "Давления атм,забойное, на выкиде насоса, на приеме насоса, буферное, линейное "), _
                                  Array(.Tbh_C, .Tintake_c, .Tdischarge_C, .Twh_C, .Tsurf_C, "Температура С,  забойное,на выкиде насоса, на приеме насоса, буферное, на поверхности "))
    ' можно еще добавить сюда вывод кривых распределения давления и температуры по стволу и еще 4 параметров  (потом)
    End With
End Function
'Public Function Well_Pwf_Hdyn_atma(PI_m3dayatm, Plin_atma, Optional Pres_atma = 250, _
'                                  Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional dcas_mm = 127, Optional dtub_mm = 62, _
'                                  Optional fw_perc = 0, Optional Rp_m3m3 As Double = -1, Optional Rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
'                                  Optional gamma_oil as double = const_gamma_oil_default, Optional gamma_wat as double = const_gamma_wat_default, Optional gamma_gas as double = const_gamma_gas_default, _
'                                  Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
'                                  Optional roughness_m As Double = 0.0001, _
'                                  Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional ESP_freq_Hz = 50, _
'                                  Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0)
'' функция расчета забойному давления скважины по линейного
'    Dim PS As New CProdSystem
'    PS.Reservoir.InitProp Pres_atma, Pb_atma, fw_perc
'    PS.Reservoir.PI_m3dayatm = PI_m3dayatm
'    Set PS.well = InitWellData(1, _
'                       Hperf_m, Hpump_m, Udl_m, dcas_mm, dtub_mm, _
'                       fw_perc, Rp_m3m3, Rsb_m3m3, Pb_atma, Tres_C, _
'                       gamma_oil, gamma_wat, gamma_gas, _
'                       Bob_m3m3, Twh_C, Tbh_C, _
'                       roughness_m, _
'                       ESP_ID, ESP_numStages, ESP_freq_Hz, _
'                       PVTcorr, HydrCorr)
'    PS.Calc_Nodal_PI Plin_atma
'    Call well.Calc_Plin_Pwf_atma(SetPT(PS.Pwf_atma, Tbh_C))     ' проведем расчет
'    With well
'        Well_Pwf_Plin_atma = Array(Array(.Pwf_atma, .Pintake_atma, .Pdischarge_atma, .Pbuf_atma, .Pline_atma, "Давления атм,забойное, на выкиде насоса, на приеме насоса, буферное, линейное "), _
'                                  Array(.Tbh_C, .Tintake_C, .Tdischarge_C, .Twh_C, .Tsurf_C, "Температура С,  забойное,на выкиде насоса, на приеме насоса, буферное, на поверхности "))
'    ' можно еще добавить сюда вывод кривых распределения давления и температуры по стволу и еще 4 параметров  (потом)
'    End With
'
'End Function
Public Function Nodal_Qliq_scm3day(PI_m3dayatm, Plin_atma, Optional Pres_atma = 250, _
                                  Optional Hperf_m = 2500, Optional Hpump_m = 2000, Optional Udl_m = 0, Optional dCas_mm = 127, Optional dtub_mm = 62, Optional dchoke_mm = -1, _
                                  Optional fw_perc = 0, Optional Rp_m3m3 As Double = -1, Optional rsb_m3m3 As Double = 100, Optional Pb_atma As Double = -1, Optional Tres_C As Double = 90, _
                                  Optional gamma_oil As Double = const_gamma_oil_default, Optional gamma_wat As Double = const_gamma_wat_default, Optional gamma_gas As Double = const_gamma_gas_default, _
                                  Optional Bob_m3m3 As Double = -1, Optional Twh_C As Double = 10, Optional Tbh_C As Double = 80, _
                                  Optional roughness_m As Double = 0.0001, _
                                  Optional ESP_ID = 0, Optional ESP_numStages = 0, Optional esp_freq_Hz = 50, _
                                  Optional PVTcorr As PVT_CORRELATION = 0, Optional HydrCorr As H_CORRELATION = 0, Optional Ksep_fr As Double = 0, _
                                  Optional Kdegr_d As Double = 0)
' расчет узлового анализа по скважине
    Dim PS As New CProdSystem
    PS.Reservoir.InitProp Pres_atma, Pb_atma, fw_perc
    PS.Reservoir.PI_m3dayatm = PI_m3dayatm
    Set PS.well = InitWellData(1, _
                       Hperf_m, Hpump_m, Udl_m, dCas_mm, dtub_mm, dchoke_mm, _
                       fw_perc, Rp_m3m3, rsb_m3m3, Pb_atma, Tres_C, _
                       gamma_oil, gamma_wat, gamma_gas, _
                       Bob_m3m3, Twh_C, Tbh_C, _
                       roughness_m, _
                       ESP_ID, ESP_numStages, esp_freq_Hz, _
                       PVTcorr, HydrCorr, Ksep_fr)
    'PS.well.ESP.PressureDegradation = Kdegr_d
    Set PS.Fluid = PS.well.Fluid
    PS.Calc_Nodal_PI Plin_atma
    Call PS.well.Calc_Plin_Pwf_atma(SetPT(PS.Pwf_atma, Tbh_C))     ' проведем расчет
    With PS.well
        Nodal_Qliq_scm3day = Array(Array(PS.Qliq_scm3day, .Pwf_atma, .Pintake_atma, .Pdischarge_atma, .Pbuf_atma, .Pline_atma, "Дебит, Давления атм,забойное, на выкиде насоса, на приеме насоса, буферное, линейное "), _
                                  Array(PS.Fluid.wc_perc, .Tbh_C, .Tintake_c, .Tdischarge_C, .Twh_C, .Tsurf_C, "Обводненность, Температура С,  забойное,на выкиде насоса, на приеме насоса, буферное, на поверхности "))
    ' можно еще добавить сюда вывод кривых распределения давления и температуры по стволу и еще 4 параметров  (потом)
    End With
End Function
' ==============  функции для расчета пласта ==========================
' =====================================================================
' расчет дебита по давлению и продуктивности
Public Function IPR_Ql_sm3Day(PI_m3dayatm, Pr_atma, Pwf_atma, _
        Optional fw_perc As Double = 0, Optional Pb_atma As Double = -1)
'
' PI_m3dayatm   - коэффициент продуктивности
' Pr_atma        - пластовое давление, атм
' Pwf_atma       - забойное давление
'
' необязательные параметры
' fw_perc      - обводненность
' Pb_atma        - давление насыщения
'
    Dim res As New CReservoir
    If Pb_atma <= 0 Then Pb_atma = 0   ' поставим ноль иначе флюид додсчитает по корреляции значение
    res.InitProp Pr_atma, Pb_atma, fw_perc
    res.PI_m3dayatm = PI_m3dayatm
    
    IPR_Ql_sm3Day = res.Calc_Q_m3Day(Pwf_atma)
    Set res = Nothing
End Function
' расчет дебита по давлению и продуктивности
Public Function IPR_Pwf_atma(PI_m3dayatm, Pr_atma, Ql_m3day, _
        Optional fw_perc As Double = 0, Optional Pb_atma As Double = -1)
'
' PI_m3dayatm   - коэффициент продуктивности
' Pr_atma        - пластовое давление, атм
' Ql_m3day      - дебит жидкости скважины на поверхности
'
' необязательные параметры
' fw_perc      - обводненность
' Pb_atma        - давление насыщения
'
    Dim res As New CReservoir
    If Pb_atma <= 0 Then Pb_atma = 0   ' поставим ноль иначе флюид додсчитает по корреляции значение
    res.InitProp Pr_atma, Pb_atma, fw_perc
    res.PI_m3dayatm = PI_m3dayatm
    
    IPR_Pwf_atma = res.Calc_Pwf_atma(Ql_m3day)
    Set res = Nothing
End Function
' расчет продуктивности
Public Function IPR_PI_sm3dayatm(Qtest_m3day, Pwftest_atma, Pr_atma, _
                Optional fw_perc As Double = 0, Optional Pb_atma As Double = -1)
'
' Qtest_m3day   - тестовый дебит скважины
' Pwftest_atma   - тестовое забойное давление
' Pr_atma        - пластовое давление, атм
'
' необязательные параметры
' fw_perc      - обводненность
' Pb_atma        - давление насыщения
'
    Dim res As New CReservoir
    If Pb_atma <= 0 Then Pb_atma = 0   ' поставим ноль иначе флюид додсчитает по корреляции значение
    res.InitProp Pr_atma, Pb_atma, fw_perc
    On Error Resume Next
    IPR_PI_sm3dayatm = res.Calc_PI_m3DayAtm(Qtest_m3day, Pwftest_atma)
    Set res = Nothing
End Function
'Функция для вычисления соответствующего диаметра порта клапана через заданный расход газа и давления в затрубе и в НКТ на глубине клапан
'Для вычисления используется уравнение Thornhill-Crave
'Возвращает диаметр порта клапана в мм
Public Function GL_dchoke_mm(Qg_m3d As Double, Pu_atma As Double, Pd_atma As Double, gamma_g As Double, Tu_C As Double)
    If Qg_m3d <= 0 Then
        GL_dchoke_mm = 0
        Exit Function
    End If
    
    If Pu_atma < Pd_atma Then
        GL_dchoke_mm = -1
        Exit Function
    End If
    Dim K As Double
    K = 1.31   ' = Cp/Cv (approx 1.31 for natural gases(R Brown) or 1.25 (Mischenko) )
    
    Dim Pu_psi As Double
    Dim Pd_psi As Double
    Pu_psi = Pu_atma * 14.2233 'upstream pressure, psi
    Pd_psi = Pd_atma * 14.2233 'downstream pressure, psi
    
    Dim Tu_F As Double
    Tu_F = Tu_C / 100 * 180 + 32
    
    Dim CD As Double  ' discharge coefficient
    CD = 0.865
    
    Dim G As Double
    G = 32.17 'ft/sec^2
    
    Dim Qg_Mcfd As Double
    Qg_Mcfd = Qg_m3d / 28.31993658
    
    Dim Pd_Pu_crit As Double
    Pd_Pu_crit = (2 / (K + 1)) ^ (K / (K - 1))
    
    Dim Pd_Pu As Double
    Pd_Pu = Pd_atma / Pu_atma
    
    Dim c0 As Double, c1 As Double, c2 As Double
    c0 = ((Pd_Pu ^ (2 / K) - Pd_Pu ^ (1 + 1 / K))) ^ 0.5
    c1 = (Pd_Pu_crit ^ (2 / K) - Pd_Pu_crit ^ (1 + 1 / K)) ^ 0.5
    c2 = (2 * G * K / (K - 1)) ^ 0.5
    
    Dim a As Double
    
    If Pd_Pu <= Pd_Pu_crit Then
        a = Qg_Mcfd / (155.5 * CD * Pu_psi * c1 * c2 / (gamma_g * (Tu_F + 460)) ^ 0.5)
    Else
        a = Qg_Mcfd / (155.5 * CD * Pu_psi * c0 * c2 / (gamma_g * (Tu_F + 460)) ^ 0.5)
    End If
    
    Dim d_in As Double
    d_in = (a * 4 / Application.PI) ^ 0.5
    
    GL_dchoke_mm = d_in / 0.03937
End Function
Function GL_dPgasPipe_atmg(ByVal H_m As Double, ByVal P_atmg As Double, ByVal T_C As Double, _
                               Optional ByVal dCas_mm As Double = 125, _
                               Optional ByVal dtub_mm As Double = 73, _
                               Optional ByVal gamma_gas As Double = 0.8, _
                               Optional ByVal Qg_scm3day As Double = 10000, _
                               Optional ByVal roughness As Double = 0.001, _
                               Optional ByVal theta As Double = 90 _
                               ) As Double
  
'de - external diameter, m
'di - interior diameter, m
'gamma_gas - relative density of gas
'qg_sc - gas flow, m3/d
'eps - pipe roughness, m
'theta - ,degree
'length - pipe length, m
'T - temperature, C
'P - pressure, atma
Dim de, di, qg_sc, eps, length, t, P
de = dCas_mm / 1000
di = dtub_mm / 1000
qg_sc = Qg_scm3day
eps = roughness
length = H_m
t = T_C
P = P_atmg
    
    'convert m3/d to scf/d
    qg_sc = qg_sc * 3.28 ^ 3
    
    Dim P_MPa As Double, P_psi As Double
    P_MPa = P * 0.1013 'convert atma to Mpa
    P_psi = P * 14.696 ' convert atma to psi
    
    
    Dim T_K As Double, T_F As Double
    T_K = t + 273 'convert Celcsius to Kelvin
    T_F = (9 / 5) * t + 32 'convert Celcsius to Fahrengheit
     
    Dim T_pc As Double
    Dim p_pc As Double
    Dim z As Double
    
'        T_pc = PseudoTemperatureStanding(gamma_gas)
'        p_pc = PseudoPressureStanding(gamma_gas)
'        Z = ZFactorDranchuk(T_K / T_pc, P_MPa / p_pc)
    z = unf_Calc_Zgas_d(T_K, P_MPa, gamma_gas)
    
    eps = eps * 39.3701 'convert m to in
    
    Dim de_in As Double, di_in As Double
    di_in = di * 39.3701 'convert m to in
    de_in = de * 39.3701 'convert m to in
    Dim dh As Double, da As Double, deq As Double
    dh = de_in - di_in
    da = (de_in ^ 2 - di_in ^ 2) ^ 0.5
    If di_in = 0 Then
        deq = de_in
    Else
        deq = (de_in ^ 2 + di_in ^ 2 - (de_in ^ 2 - di_in ^ 2) / Log(de_in / di_in)) / (de_in - di_in)
    End If
    Dim mu_g As Double
    mu_g = unf_calc_Mug_cP(T_K, P_MPa, z, gamma_gas)
    Dim Re As Double
    Re = 0.020107 * gamma_gas * Abs(qg_sc) * deq / mu_g / da ^ 2
    Dim a As Double, B As Double
    a = (2.457 * Log(1 / ((7 / Re) ^ 0.9 + 0.27 * eps / deq))) ^ 16
    B = (37530 / Re) ^ 16
    Dim f_moody As Double
    f_moody = 8 * ((8 / Re) ^ 12 + 1 / ((a + B) ^ 1.5)) ^ (1 / 12)
    
    Dim gradP As Double
    
    gradP = -0.018786 * gamma_gas * (P_psi + 14.7) * Sin(theta * Application.PI / 180) / (T_F + 460) / z + (1.2595 * 10 ^ (-11)) * f_moody * (T_F + 460) * z * gamma_gas * (qg_sc ^ 2) / (P_psi + 14.7) / dh / da ^ 4
    gradP = gradP * 0.068 / 0.3048 'convert psi/ft to atma/m
    
    GL_dPgasPipe_atmg = P + gradP * length
    
    
End Function
' function to calculated gas passage trough orifice or gas valve
' link in K Brawn AL 2A - Craft, Holden, Graves (p.111)
' also found in Mischenko book
Public Function GL_Qgasvalve_m3day(d_mm As Double, Pu_atma As Double, Pd_atma As Double, gamma_g As Double, Tu_C As Double)
    
    Dim K As Double
    K = 1.31   ' = Cp/Cv (approx 1.31 for natural gases(R Brown) or 1.25 (Mischenko) )
    
    Dim d_in As Double
    d_in = d_mm * 0.03937
    
    Dim Pu_psi As Double
    Dim Pd_psi As Double
    Pu_psi = Pu_atma * 14.2233 'upstream pressure, psi
    Pd_psi = Pd_atma * 14.2233 'downstream pressure, psi
    
    Dim Tu_F As Double
    Tu_F = Tu_C / 100 * 180 + 32
    
    Dim Pd_Pu_crit As Double
    Pd_Pu_crit = (2 / (K + 1)) ^ (K / (K - 1))
    
    
    Dim CD As Double  ' discharge coefficient
    CD = 0.865
    
    Dim G As Double
    G = 32.17 'ft/sec^2
    
    Dim c0 As Double, c1 As Double, c2 As Double
    c1 = (Pd_Pu_crit ^ (2 / K) - Pd_Pu_crit ^ (1 + 1 / K)) ^ 0.5
    c2 = (2 * G * K / (K - 1)) ^ 0.5
    
    Dim a As Double
    a = Application.PI * d_in ^ 2 / 4 'area of choke, sq in.
    
    Dim Qg_crit As Double
    Qg_crit = 155.5 * CD * a * Pu_psi * c1 * c2 / (gamma_g * (Tu_F + 460)) ^ 0.5 'critical flow ratio, Mcf/d
    
    Dim Pd_Pu As Double
    Pd_Pu = Pd_atma / Pu_atma
    
    If Pd_Pu >= 1 Then
        GL_Qgasvalve_m3day = 0
        Exit Function
    End If
    
    If Pd_Pu <= 0 Then
        GL_Qgasvalve_m3day = 0
        Exit Function
    End If
    
    If Pd_Pu <= Pd_Pu_crit Then
        GL_Qgasvalve_m3day = Qg_crit * 28.31993658
    Else
        c0 = ((Pd_Pu ^ (2 / K) - Pd_Pu ^ (1 + 1 / K))) ^ 0.5
        GL_Qgasvalve_m3day = Qg_crit * 28.31993658 * c0 / c1
    End If
End Function
Public Function GL_Pd_gas_valve_atma(d_mm As Double, Pu_atma As Double, Qg_m3day As Double, gamma_g As Double, Tu_C As Double)
' расчет перепада давления на клапане при проходе газа через него
Dim Qmax_m3day As Double, Qtest_m3day As Double
Dim Pd As Double, Pd2 As Double, Pd1 As Double
Pd = 1
    Dim K As Double
    K = 1.31   ' = Cp/Cv (approx 1.31 for natural gases(R Brown) or 1.25 (Mischenko) )
    Dim Pd_Pu_crit As Double
    Pd_Pu_crit = (2 / (K + 1)) ^ (K / (K - 1))
'    Dim Pd_Pu As Double
'    Pd_Pu = Pd_atma / Pu_atma
 Dim i As Integer
 i = 0
Qmax_m3day = GL_Qgasvalve_m3day(d_mm, Pu_atma, Pd, gamma_g, Tu_C)
If Qmax_m3day > Qg_m3day Then
    Pd1 = Pd_Pu_crit * Pu_atma
    Pd2 = Pu_atma
    Do
        i = i + 1
        Pd = (Pd2 + Pd1) / 2
        Qtest_m3day = GL_Qgasvalve_m3day(d_mm, Pu_atma, Pd, gamma_g, Tu_C)
        If Qg_m3day > Qtest_m3day Then
            Pd2 = Pd
        Else
            Pd1 = Pd
        End If
    Loop While (Abs(Qg_m3day - Qtest_m3day) > 0.01) And (i < 100)
    GL_Pd_gas_valve_atma = Pd
Else
    GL_Pd_gas_valve_atma = Pu_atma
End If
End Function
    
' функция расчета коэффициента Джоуля Томсона
Public Function PVT_CJT_Katm(P_atma, T_C, _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 As Double = -1, _
                    Optional Pb_atma As Double = -1, _
                    Optional Tres_C As Double = const_Tres_default, _
                    Optional Bob_m3m3 As Double = -1, _
                    Optional Ql_m3day As Double = 10, _
                    Optional wc_perc As Double = 0, _
                    Optional PVTcorr = StandingBased) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas        удельная плотность газа, по воздуху.
'               const_gamma_gas_default = 0.6
' gamma_oil        удельная плотность нефти, по воде.
'               const_gamma_oil_default = 0.86
' gamma_wat        удельная плотность воды, по воде.
'               const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'               const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3. Калибровочный параметр.
'           По умолчанию не задается, рассчитывается по газосодержанию
' Pb_atma    давление насыщения, атм. Калибровочный параметр.
'           По умолчанию не задается, рассчитывается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'               const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3. Калибровочный параметрв.
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций используемых для расчета
'               StandingBased = 0 - на основе кор-ии Стендинга
'               McCainBased = 1 - на основе кор-ии Маккейна
'               StraigthLine = 2 - на основе упрощенных зависимостей
'
' выходное значение - число - объемный коэффициент газа при заданных
'           термобарических условиях, м3/м3.
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3
    PVT.Qliq_scm3day = Ql_m3day
    PVT.wc_perc = wc_perc
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(T_C))
    PVT_CJT_Katm = PVT.CJT_Katm
End Function
Public Function PVT_Encode_string( _
                    Optional gamma_gas As Double = const_gamma_gas_default, _
                    Optional gamma_oil As Double = const_gamma_oil_default, _
                    Optional gamma_wat As Double = const_gamma_wat_default, _
                    Optional rsb_m3m3 = const_Rsb_default, _
                    Optional Rp_m3m3 = -1, _
                    Optional Pb_atma = -1, _
                    Optional Tres_C = const_Tres_default, _
                    Optional Bob_m3m3 = -1, _
                    Optional Muob_cP = -1, _
                    Optional PVTcorr = StandingBased, _
                    Optional Ksep_fr = 0, _
                    Optional PKsep_atma = -1, _
                    Optional TKsep_C = -1 _
                    )
' функция кодирования значений PVT в строку, которую можно потом использовать
    Dim str As String
    Dim frmt As String
    Dim frmt_int As String
    frmt = "#0.##0"
    frmt_int = "0"
    str = ""
    str = str & "gamma_gas:" & Format(gamma_gas, frmt) & ";"
    str = str & "gamma_oil:" & Format(gamma_oil, frmt) & ";"
    str = str & "gamma_wat:" & Format(gamma_wat, frmt) & ";"
    str = str & "rsb_m3m3:" & Format(rsb_m3m3, frmt) & ";"
    str = str & "Rp_m3m3:" & Format(Rp_m3m3, frmt) & ";"
    str = str & "Pb_atma:" & Format(Pb_atma, frmt) & ";"
    str = str & "Tres_C:" & Format(Tres_C, frmt) & ";"
    str = str & "Bob_m3m3:" & Format(Bob_m3m3, frmt) & ";"
    str = str & "Muob_cP:" & Format(Muob_cP, frmt) & ";"
    str = str & "PVTcorr:" & Format(PVTcorr, frmt_int) & ";"
    str = str & "Ksep_fr:" & Format(Ksep_fr, frmt) & ";"
    str = str & "PKsep_atma:" & Format(PKsep_atma, frmt) & ";"
    str = str & "TKsep_C:" & Format(TKsep_C, frmt) & ";"
    PVT_Encode_string = str
    
End Function
Public Function PVT_Decode_string(PVTstr As String, Optional getStr As Boolean = False)
' функция расшифровки значений PVT свойств
    Dim a
    Dim s As String
    Dim i As Integer
    Dim B
    Dim P_atma As Double
    Dim T_C, gamma_gas As Double, gamma_oil As Double, _
               gamma_wat As Double, rsb_m3m3 As Double, Rp_m3m3 As Double, _
              Pb_atma As Double, Tres_C As Double, Bob_m3m3 As Double, Muob_cP As Double _
              , PVTcorr, Ksep_fr As Double, PKsep_atma As Double, TKsep_C As Double
On Error GoTo er1:
' ловим все ошибки, все должно пройти идеально при дешифровке
'
    
    s = PVTstr '.Cells(1, 1).Value2
    
    a = Split(s, ";")
    i = 0
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "gamma_gas" And B(1) <> "" Then
        gamma_gas = CDbl(B(1))
    End If
    B = Split(a(i), ":")
    i = i + 1
        
    If B(0) = "gamma_oil" And B(1) <> "" Then gamma_oil = CDbl(B(1))
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "gamma_wat" And B(1) <> "" Then gamma_wat = CDbl(B(1))
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "rsb_m3m3" And B(1) <> "" Then rsb_m3m3 = CDbl(B(1))
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "Rp_m3m3" And B(1) <> "" Then Rp_m3m3 = CDbl(B(1))
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "Pb_atma" And B(1) <> "" Then
        Pb_atma = CDbl(B(1))
    ElseIf B(1) = "" Then
        ' калибровочный параметр проверяем специально и не даем сохраниться значению по умолчанию
        ' если он неправильно указан (дублируется инициализацией в конструкторе, но все же)
        Pb_atma = -1
    End If
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "Tres_C" And B(1) <> "" Then Tres_C = CDbl(B(1))
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "Bob_m3m3" And B(1) <> "" Then
        ' калибровочный параметр проверяем специально и не даем сохраниться значению по умолчанию
        ' если он неправильно указан (дублируется инициализацией в конструкторе, но все же)
        Bob_m3m3 = CDbl(B(1))
    ElseIf B(1) = "" Then
        Bob_m3m3 = -1
    End If
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "Muob_cP" And B(1) <> "" Then
        ' калибровочный параметр проверяем специально и не даем сохраниться значению по умолчанию
        ' если он неправильно указан (дублируется инициализацией в конструкторе, но все же)
        Muob_cP = CDbl(B(1))
    ElseIf B(1) = "" Then
        Muob_cP = -1
    End If
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "PVTcorr" And B(1) <> "" Then PVTcorr = CDbl(B(1))
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "Ksep_fr" And B(1) <> "" Then Ksep_fr = CDbl(B(1))
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "PKsep_atma" And B(1) <> "" Then PKsep_atma = CDbl(B(1))
    B = Split(a(i), ":"): i = i + 1
    If B(0) = "TKsep_C" And B(1) <> "" Then TKsep_C = CDbl(B(1))
    
    Dim PVT As New CPVT
    PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
    If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
        Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    End If
    If getStr Then
        PVT_Decode_string = PVT_Encode_string(gamma_gas, gamma_oil, _
               gamma_wat, rsb_m3m3, Rp_m3m3, _
              Pb_atma, Tres_C, Bob_m3m3, Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, _
              TKsep_C)
    Else
        Set PVT_Decode_string = PVT
    End If
    Exit Function
er1:
    addLogMsg_debug "PVT_Decode_string. error reading PVT str:", PVTstr
    Err.Raise vbObjectError + 1, , "PVT_Decode_string. error reading PVT str"
    
End Function
