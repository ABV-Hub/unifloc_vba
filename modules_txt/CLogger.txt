'=======================================================================================
'Unifloc 7.7  Vulpes zerda                                           khabibullin.ra@gubkin.ru
'Petroleum engineering calculations modules (macroses)
'2000 - 2019
'
'=======================================================================================
'
'  Clogger - класс описывающий объект логирования и контроля качества расчетов
'  Logger живет паралельно с расчетныим классами и умеет принимать от них сообщения о нештатных ситуациях при проведении расчетов
'           он копит информацию и теоретически может ее анализировать и строить статистику
'
Public MsgList As New Collection    ' список всех сообщений об ошибках
'Private p_ContextStack As New Collection ' стек текущего контекста вычислений
'
'Private p_ContextLevel As Integer ' уровень вложенности текущего контекста
Private Sub Class_Initialize()
    p_ContextLevel = 0 ' изначально уровень равен нулю - контекста нет
End Sub
Public Sub ClearAll()
 Set MsgList = Nothing
 Set MsgList = New Collection
End Sub
 ' функция для передачи сообщения о предупреждении или ошибки для обработки
 ' параметры
 '      - описание ошибки
 '      - уровень ошибки  - критическая ошибка, предупреждение, коррекция данных
 '      - контекст в котором вызвана ошибка - название функции, тип расчета который ведется (как собрать? можно сделать общий параметр у класса отвественный за контекст проведения расчета)
 
 
 Public Function AddMsg(msg As String, Optional MsgType As MESSAGE_TYPE = msgWarning, Optional MsgNum As Integer = 0, Optional level As MESSAGE_LEVEL = mlLow) As Long
   
  On Error Resume Next
   Dim lm As CLogMsg
   Set lm = New CLogMsg    ' создали новый объект
   
   lm.name = msg
   lm.Rating = level
   lm.TypeErr = MsgType
   
   MsgList.Add lm          ' добавляем сообщение в список
   
   AddMsg = MsgList.Count
   
   If MsgType = msgError Then
     Err.Raise vbObjectError + MsgNum, , msg
   End If
 End Function
Public Function SaveToFile()
    Dim FullFileName As String
    Dim dir As String
    Dim FSO As FileSystemObject, ts As TextStream, fil As File
    
    FullFileName = ThisWorkbook.Path & "\" & "oppump.log"
    Set FSO = CreateObject("scripting.filesystemobject")
    
    If FSO.FileExists(FullFileName) Then Kill FullFileName
    
    Set ts = FSO.OpenTextFile(FullFileName, ForWriting, True)
    Dim ST As CLogMsg
    
On Error Resume Next
    ' on english version office - russian letter can cause file write error here
    For Each ST In MsgList
        ts.WriteLine ST.TypeErr & " " & ST.name:
    Next
    
    ts.Close: Set ts = Nothing: Set FSO = Nothing
End Function
